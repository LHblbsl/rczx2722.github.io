<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å‘˜å‘å¸ƒ - ç­çº§ç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.13.2/dist/av-min.js"></script>
    <style>
        /* æ—¶é—´è®¾ç½®ç›¸å…³æ ·å¼ */
        /* ç¾åŒ–æ—¶é—´è®¾ç½®ç•Œé¢ */
        .time-mode-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .time-mode-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-weight: 500;
        }

            .time-mode-btn.active {
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                border-color: #667eea;
                transform: scale(1.02);
            }

        .time-settings-section {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 1px solid #e1e5e9;
        }

        .time-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .time-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

            .time-input:focus {
                border-color: #667eea;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            }

        .datetime-inputs {
            display: flex;
            gap: 8px;
            align-items: center;
        }

            .datetime-inputs select {
                flex: 1;
                padding: 12px;
                border: 2px solid #e1e5e9;
                border-radius: 8px;
                background: white;
                cursor: pointer;
            }

        .time-hint {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        /* æ¡ç›®é€‰æ‹©æ ·å¼ */
        .item-selection-section {
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .time-item-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            margin: 5px 0;
            background: white;
            border-radius: 8px;
            border: 1px solid #e1e5e9;
            transition: all 0.3s ease;
        }

            .time-item-checkbox:hover {
                background: #f8f9fa;
                border-color: #667eea;
            }

            .time-item-checkbox input[type="checkbox"] {
                width: 18px;
                height: 18px;
                border-radius: 4px;
                border: 2px solid #ddd;
                cursor: pointer;
            }

                .time-item-checkbox input[type="checkbox"]:checked {
                    background: #667eea;
                    border-color: #667eea;
                }

        .item-number {
            font-weight: 600;
            color: #667eea;
            min-width: 20px;
        }

        .item-content-preview {
            flex: 1;
            font-size: 14px;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
       
        .time-settings-section {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .datetime-inputs {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .item-selection-section {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .time-item-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 8px 0;
            padding: 8px;
            background: white;
            border-radius: 6px;
        }

        .deadline-info {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            font-size: 14px;
        }

        .countdown-timer {
            color: #e74c3c;
            font-weight: bold;
            margin-left: 5px;
        }
        /* è¿›åº¦æ¡æ ·å¼ */
        .upload-progress {
            width: 100%;
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            margin: 10px 0;
            overflow: hidden;
            display: none;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #00b894, #00a085);
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            font-size: 12px;
            color: #666;
            text-align: center;
            margin-top: 5px;
        }

        .uploading .file-upload-area {
            opacity: 0.6;
            pointer-events: none;
        }
        /* å›¾ç‰‡ä¸Šä¼ ç›¸å…³æ ·å¼ */
        .header-actions {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .header-action-btn {
            padding: 15px 20px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 140px;
            justify-content: center;
        }

            .header-action-btn.file-btn {
                background: linear-gradient(135deg, #00b894, #00a085);
                box-shadow: 0 4px 15px rgba(0, 184, 148, 0.3);
            }

            .header-action-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            }

            .header-action-btn:active {
                transform: translateY(0);
            }
        .image-preview-area {
            margin-bottom: 20px;
            max-height: 200px;
            overflow-y: auto;
        }

        .image-preview-item {
            position: relative;
            display: inline-block;
            margin: 5px;
            border-radius: 8px;
            overflow: hidden;
        }

        .image-preview {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
        }

        .remove-image-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(231, 76, 60, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
        }

        .file-info-area {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #e1e5e9;
        }

        .file-upload-area {
            border: 2px dashed #00b894;
            border-radius: 12px;
            padding: 30px 20px;
            text-align: center;
            background: rgba(0, 184, 148, 0.05);
            margin-bottom: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

            .file-upload-area.drag-over {
                background: rgba(0, 184, 148, 0.1);
                border-color: #00a085;
                transform: scale(1.02);
            }

        .file-upload-icon {
            font-size: 48px;
            margin-bottom: 10px;
            color: #00b894;
        }

        .file-upload-text {
            font-size: 16px;
            color: #555;
            margin-bottom: 8px;
        }

        .file-upload-hint {
            font-size: 12px;
            color: #888;
        }

        /* æ–‡ä»¶åˆ—è¡¨æ ·å¼ */
        .file-list {
            margin-top: 15px;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid #00b894;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .file-icon {
            font-size: 20px;
            color: #00b894;
        }

        .file-details {
            flex: 1;
        }

        .file-name {
            font-weight: 500;
            color: #333;
            margin-bottom: 2px;
        }

        .file-size {
            font-size: 12px;
            color: #666;
        }

        .file-remove {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 12px;
        }

        /* ä¸Šä¼ ç»Ÿè®¡ä¿¡æ¯ */
        .upload-stats {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .stats-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .stats-limit {
            color: #e74c3c;
            font-weight: 600;
        }

        .file-summary {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #666;
        }

        .file-count-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .count-btn {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 6px;
            background: #3498db;
            color: white;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .count-display {
            font-weight: 600;
            color: #333;
            min-width: 30px;
            text-align: center;
        }

        .file-hint {
            font-size: 12px;
            color: #e74c3c;
            margin-top: 5px;
        }

        /* è°ƒæ•´æ¨¡æ€æ¡†ä½ç½® */
        .modal-content {
            background: white;
            border-radius: 20px 20px 0 0;
            padding: 30px 20px 20px;
            width: 100%;
            position: absolute;
            bottom: 5%;
            left: 0;
            transform: translateY(100%);
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            max-height: 90vh;
            overflow-y: auto;
        }
        .time-input {
            width: 120px;
            padding: 12px;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

            .time-input:focus {
                border-color: #00b894;
                box-shadow: 0 0 0 2px rgba(0, 184, 148, 0.1);
            }

        .time-hint {
            font-size: 12px;
            color: #00b894;
            margin-top: 4px;
            animation: fadeIn 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f6fa;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ä¸»å®¹å™¨ */
        .app-container {
            max-width: 100%;
            min-height: 100vh;
            background: white;
            border-radius: 0;
            position: relative;
            overflow: hidden;
        }

        /* é¡¶éƒ¨çŠ¶æ€æ  */
        .status-bar {
            height: 44px;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            color: #666;
            font-size: 14px;
        }

        /* å¤´éƒ¨å¯¼èˆª */
        .header {
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .app-title {
            font-size: 20px;
            font-weight: 700;
            color: #333;
        }

        .back-btn {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

            .back-btn:active {
                transform: scale(0.95);
            }

        /* åŠŸèƒ½æ¿å—å®¹å™¨ */
        .sections-container {
            padding: 20px;
            display: grid;
            gap: 20px;
        }

        /* åŠŸèƒ½æ¿å—é€šç”¨æ ·å¼ */
        .section {
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

            .section:active {
                transform: scale(0.98);
            }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: white;
        }

        .section-icon {
            font-size: 24px;
        }

        /* ä¸åŒæ¿å—çš„é¢œè‰² */
        .section-homework {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: #667eea;
        }

        .section-reading {
            background: linear-gradient(135deg, #00b894, #00a085);
            border-color: #00b894;
        }

        .section-call {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            border-color: #f39c12;
        }

        .section-important {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            border-color: #e74c3c;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: white;
            border-radius: 20px 20px 0 0;
            padding: 30px 20px 20px;
            width: 100%;
            position: absolute;
            bottom: 0;
            left: 0;
            transform: translateY(100%);
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 20px;
            text-align: center;
            position: relative;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: #333;
        }

        .close-btn {
            position: absolute;
            right: 0;
            top: 0;
            background: none;
            border: none;
            font-size: 20px;
            color: #666;
            cursor: pointer;
        }

        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: 20px;
        }

            .form-group label {
                display: block;
                margin-bottom: 8px;
                color: #555;
                font-weight: 500;
                font-size: 14px;
            }

        .form-control {
            width: 100%;
            padding: 16px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #fafafa;
        }

            .form-control:focus {
                outline: none;
                border-color: #667eea;
                background: white;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            }

        textarea.form-control {
            height: 120px;
            resize: vertical;
        }

        /* æ¡ç›®åˆ—è¡¨ */
        .items-list {
            margin-bottom: 20px;
        }

        .item-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .item-number {
            font-weight: 600;
            color: #666;
            min-width: 30px;
        }

        .item-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
        }

        .time-input {
            width: 120px;
            padding: 12px;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
        }

        .remove-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .add-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 15px;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            width: 100%;
            margin-top: 10px;
        }

            .btn:active {
                transform: scale(0.95);
                box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
            }

        .btn-homework {
            background: linear-gradient(135deg, #667eea, #764ba2);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-reading {
            background: linear-gradient(135deg, #00b894, #00a085);
            box-shadow: 0 4px 15px rgba(0, 184, 148, 0.3);
        }

        .btn-important {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            box-shadow: 0 4px 15px rgba(149, 165, 166, 0.3);
        }

        /* æ¨¡æ¿ç®¡ç† */
        .template-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #f0f0f0;
        }

        .template-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .template-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }

        .save-template {
            background: #27ae60;
            color: white;
        }

        .load-template {
            background: #3498db;
            color: white;
        }

        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .file-upload-area, .file-list, .upload-stats {
            animation: slideDown 0.3s ease;
        }

        /* æ¶ˆæ¯æç¤º */
        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
        }

            .toast.show {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
        <div class="status-bar">
            <div id="currentTime"></div>
            <div id="networkStatus">åœ¨çº¿</div>
        </div>

        <!-- å¤´éƒ¨ -->
        <div class="header">
            <div class="header-content">
                <button class="back-btn" onclick="goBack()">â† è¿”å›</button>
                <div class="app-title">ç®¡ç†å‘˜å‘å¸ƒ</div>
                <div style="width: 60px;"></div>
            </div>
        </div>

        <!-- åŠŸèƒ½æ¿å— -->
        <!-- åŠŸèƒ½æ¿å— -->
        <div class="sections-container">
            <!-- å‘å¸ƒä½œä¸š -->
            <div class="section section-homework" onclick="openHomeworkModal()">
                <div class="section-header">
                    <div class="section-title">å‘å¸ƒä½œä¸š</div>
                    <div class="section-icon">ğŸ“š</div>
                </div>
                <div style="color: rgba(255,255,255,0.8); font-size: 14px;">
                    å¸ƒç½®æ¯æ—¥ä½œä¸šå’Œç»ƒä¹ 
                </div>
            </div>

            <!-- å‘å¸ƒæ—©æ™šè¯» -->
            <div class="section section-reading" onclick="openReadingModal()">
                <div class="section-header">
                    <div class="section-title">å‘å¸ƒæ—©æ™šè¯»</div>
                    <div class="section-icon">ğŸ“–</div>
                </div>
                <div style="color: rgba(255,255,255,0.8); font-size: 14px;">
                    å®‰æ’æ™¨è¯»å’Œæ™šè¯»å†…å®¹
                </div>
            </div>

            <!-- å¬å”¤åŒå­¦ -->
            <div class="section section-call" onclick="goToStudentSummon()">
                <div class="section-header">
                    <div class="section-title">å¬å”¤åŒå­¦</div>
                    <div class="section-icon">ğŸ“¢</div>
                </div>
                <div style="color: rgba(255,255,255,0.8); font-size: 14px;">
                    å¿«é€Ÿå¬å”¤å­¦ç”Ÿï¼Œæé«˜è¯¾å ‚æ•ˆç‡
                </div>
            </div>

            <!-- å‘å¸ƒé‡è¦æ¶ˆæ¯ -->
            <div class="section section-important" onclick="openImportantModal()">
                <div class="section-header">
                    <div class="section-title">å‘å¸ƒé‡è¦æ¶ˆæ¯</div>
                    <div class="section-icon">âš ï¸</div>
                </div>
                <div style="color: rgba(255,255,255,0.8); font-size: 14px;">
                    ç´§æ€¥é€šçŸ¥å’Œé‡è¦å…¬å‘Š
                </div>
            </div>
        </div>
    </div>

    <!-- å‘å¸ƒä½œä¸šæ¨¡æ€æ¡† -->
    <div id="homeworkModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">å‘å¸ƒä½œä¸š</h3>
                <div class="header-actions">
                    <button class="header-action-btn" onclick="triggerImageUpload('homework')">
                        ğŸ“· æ·»åŠ å›¾ç‰‡
                    </button>
                    <button class="header-action-btn" onclick="showFileSettings('homework')">
                        ğŸ“ æ–‡ä»¶è®¾ç½®
                    </button>
                    <!-- æ·»åŠ æ—¶é—´è®¾ç½®æŒ‰é’® -->
                    <button class="header-action-btn" onclick="showTimeSettings('homework')">
                        â° æ—¶é—´è®¾ç½®
                    </button>
                </div>
                <button class="close-btn" onclick="closeModal('homeworkModal')">Ã—</button>
            </div>

            <!-- å›¾ç‰‡é¢„è§ˆåŒºåŸŸ -->
            <div id="homeworkImagePreview" class="image-preview-area" style="display: none;">
                <!-- åŠ¨æ€ç”Ÿæˆçš„å›¾ç‰‡é¢„è§ˆ -->
            </div>

            <!-- æ–‡ä»¶ä¿¡æ¯åŒºåŸŸ -->
            <div id="homeworkFileInfo" class="file-info-area" style="display: none;">
                <!-- ä¸Šä¼ ç»Ÿè®¡ -->
                <div class="upload-stats">
                    <div class="stats-item">
                        <span>ä»Šæ—¥å·²ä¸Šä¼ :</span>
                        <span id="homeworkTodayUsage">0MB / 30MB</span>
                    </div>
                    <div class="stats-item">
                        <span>å‰©ä½™é¢åº¦:</span>
                        <span class="stats-limit" id="homeworkRemaining">30MB</span>
                    </div>
                </div>

                <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
                <div class="file-upload-area" id="homeworkFileUpload"
                     ondragover="handleDragOver(event)"
                     ondragleave="handleDragLeave(event)"
                     ondrop="handleFileDrop('homework', event)"
                     onclick="triggerFileUpload('homework')">
                    <div class="file-upload-icon">ğŸ“</div>
                    <div class="file-upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤åŒºåŸŸ</div>
                    <div class="file-upload-hint">å•ä¸ªæ–‡ä»¶ä¸è¶…è¿‡10MBï¼Œä»Šæ—¥æ€»ä¸Šé™30MB</div>
                </div>

                <!-- æ–‡ä»¶åˆ—è¡¨ -->
                <div class="file-list" id="homeworkFileList">
                    <!-- åŠ¨æ€ç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨ -->
                </div>

                <div class="file-hint">
                    âš ï¸ æ–‡ä»¶å°†åœ¨3å¤©åè‡ªåŠ¨åˆ é™¤ï¼Œé‡è¦æ–‡ä»¶è¯·ä½¿ç”¨QQå‘é€
                </div>
            </div>
            <!-- åœ¨æ–‡ä»¶ä¿¡æ¯åŒºåŸŸåé¢æ·»åŠ æ—¶é—´è®¾ç½®åŒºåŸŸ -->
            <!-- æ›¿æ¢åŸæ¥çš„æ—¶é—´è®¾ç½®åŒºåŸŸ -->
            <div id="homeworkTimeInfo" class="file-info-area" style="display: none;">
                <div class="upload-stats">
                    <div class="stats-item">
                        <span>æ—¶é—´è®¾ç½®æ¨¡å¼:</span>
                    </div>
                </div>

                <!-- ç¾åŒ–åçš„æ—¶é—´æ¨¡å¼é€‰æ‹© -->
                <div class="time-mode-selector">
                    <div class="time-mode-btn active" data-mode="countdown" onclick="selectTimeMode('homework', 'countdown')">
                        â±ï¸ å€’æ•°æ¨¡å¼
                        <div class="time-hint">è®¾ç½®å‰©ä½™å°æ—¶æ•°</div>
                    </div>
                    <div class="time-mode-btn" data-mode="datetime" onclick="selectTimeMode('homework', 'datetime')">
                        ğŸ“… æ—¥æœŸæ¨¡å¼
                        <div class="time-hint">é€‰æ‹©å…·ä½“æ—¥æœŸæ—¶é—´</div>
                    </div>
                </div>

                <!-- å€’æ•°æ¨¡å¼è®¾ç½® -->
                <div id="homeworkCountdownSettings" class="time-settings-section">
                    <div class="form-group">
                        <label>å‰©ä½™æ—¶é—´è®¾ç½®</label>
                        <div class="time-input-group">
                            <input type="number" id="homeworkCountdownHours" class="time-input"
                                   placeholder="è¾“å…¥å°æ—¶æ•°ï¼ˆå¯å°æ•°ï¼‰" step="0.1" min="0.1">
                            <span style="white-space: nowrap;">å°æ—¶</span>
                        </div>
                        <div class="time-hint">ä¾‹å¦‚ï¼š1.5å°æ—¶ = 90åˆ†é’Ÿï¼Œ0.5å°æ—¶ = 30åˆ†é’Ÿ</div>
                    </div>
                </div>

                <!-- æ—¥æœŸæ¨¡å¼è®¾ç½® -->
                <div id="homeworkDatetimeSettings" class="time-settings-section" style="display: none;">
                    <div class="form-group">
                        <label>æˆªæ­¢æ—¥æœŸå’Œæ—¶é—´</label>
                        <div class="datetime-inputs">
                            <select id="homeworkDeadlineMonth" class="time-input">
                                <option value="">é€‰æ‹©æœˆä»½</option>
                                <!-- æœˆä»½é€‰é¡¹å°†é€šè¿‡JSç”Ÿæˆ -->
                            </select>
                            <select id="homeworkDeadlineDay" class="time-input">
                                <option value="">é€‰æ‹©æ—¥æœŸ</option>
                                <!-- æ—¥æœŸé€‰é¡¹å°†é€šè¿‡JSç”Ÿæˆ -->
                            </select>
                            <select id="homeworkDeadlineHour" class="time-input">
                                <option value="">é€‰æ‹©å°æ—¶</option>
                                <!-- å°æ—¶é€‰é¡¹å°†é€šè¿‡JSç”Ÿæˆ -->
                            </select>
                        </div>
                    </div>
                </div>

                <!-- ç²¾ç®€çš„æ¡ç›®é€‰æ‹©åŒºåŸŸ -->
                <div class="item-selection-section">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600;">é€‰æ‹©åº”ç”¨æ—¶é—´çš„ä½œä¸šæ¡ç›®:</label>
                    <div id="homeworkTimeItems">
                        <!-- åŠ¨æ€ç”Ÿæˆçš„æ¡ç›®é€‰æ‹© -->
                    </div>
                </div>

                <!-- åœ¨ä½œä¸šæ¨¡æ€æ¡†çš„æ—¶é—´è®¾ç½®åŒºåŸŸ -->
                <button class="btn" onclick="applyTimeSettings('homework')"
                        style="margin-top: 15px; background: linear-gradient(135deg, #3498db, #2980b9); width: 100%;">
                    âœ… åº”ç”¨æ—¶é—´è®¾ç½®
                </button>
            </div>

            <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
            <input type="file" id="homeworkFileInput" multiple style="display: none;"
                   onchange="handleFileUpload('homework', this.files)">

            <div class="form-group">
                <input type="text" id="homeworkTitle" class="form-control" placeholder="ä½œä¸šæ ‡é¢˜/ç§‘ç›®">
            </div>

            <div class="form-group">
                <label>ä½œä¸šå†…å®¹ï¼ˆæ¯è¡Œä¸€æ¡ï¼‰</label>
                <div class="items-list" id="homeworkItems">
                    <!-- åŠ¨æ€ç”Ÿæˆçš„æ¡ç›® -->
                </div>
                <button class="add-btn" onclick="addHomeworkItem()">+ æ·»åŠ æ¡ç›®</button>
            </div>

            <div class="template-section">
                <label>æ¨¡æ¿ç®¡ç†</label>
                <div class="template-buttons">
                    <button class="template-btn save-template" onclick="saveHomeworkTemplate()">ä¿å­˜æ¨¡æ¿</button>
                    <button class="template-btn load-template" onclick="loadHomeworkTemplate()">åŠ è½½æ¨¡æ¿</button>
                </div>
            </div>

            <button class="btn btn-homework" onclick="publishHomework()">å‘å¸ƒä½œä¸š</button>
            <button class="btn btn-secondary" onclick="closeModal('homeworkModal')">å–æ¶ˆ</button>

            <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
            <input type="file" id="homeworkImageInput" accept="image/*" multiple style="display: none;"
                   onchange="handleImageUpload('homework', this.files)">
        </div>
    </div>

    <!-- å‘å¸ƒæ—©æ™šè¯»æ¨¡æ€æ¡† -->
    <div id="readingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">å‘å¸ƒæ—©æ™šè¯»</h3>
                <div class="header-actions">
                    <button class="header-action-btn" onclick="triggerImageUpload('reading')">
                        ğŸ“· æ·»åŠ å›¾ç‰‡
                    </button>
                    <button class="header-action-btn" onclick="showFileSettings('reading')">
                        ğŸ“ æ–‡ä»¶è®¾ç½®
                    </button>
                    <!-- æ·»åŠ æ—¶é—´è®¾ç½®æŒ‰é’® -->
                    <button class="header-action-btn" onclick="showTimeSettings('reading')">
                        â° æ—¶é—´è®¾ç½®
                    </button>
                </div>
                <button class="close-btn" onclick="closeModal('readingModal')">Ã—</button>
            </div>

            <!-- å›¾ç‰‡é¢„è§ˆåŒºåŸŸ -->
            <div id="readingImagePreview" class="image-preview-area" style="display: none;">
                <!-- åŠ¨æ€ç”Ÿæˆçš„å›¾ç‰‡é¢„è§ˆ -->
            </div>

            <!-- æ–‡ä»¶ä¿¡æ¯åŒºåŸŸ -->
            <div id="readingFileInfo" class="file-info-area" style="display: none;">
                <!-- ä¸Šä¼ ç»Ÿè®¡ -->
                <div class="upload-stats">
                    <div class="stats-item">
                        <span>ä»Šæ—¥å·²ä¸Šä¼ :</span>
                        <span id="readingTodayUsage">0MB / 30MB</span>
                    </div>
                    <div class="stats-item">
                        <span>å‰©ä½™é¢åº¦:</span>
                        <span class="stats-limit" id="readingRemaining">30MB</span>
                    </div>
                </div>

                <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
                <div class="file-upload-area" id="readingFileUpload"
                     ondragover="handleDragOver(event)"
                     ondragleave="handleDragLeave(event)"
                     ondrop="handleFileDrop('reading', event)"
                     onclick="triggerFileUpload('reading')">
                    <div class="file-upload-icon">ğŸ“</div>
                    <div class="file-upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤åŒºåŸŸ</div>
                    <div class="file-upload-hint">å•ä¸ªæ–‡ä»¶ä¸è¶…è¿‡10MBï¼Œä»Šæ—¥æ€»ä¸Šé™30MB</div>
                </div>

                <!-- æ–‡ä»¶åˆ—è¡¨ -->
                <div class="file-list" id="readingFileList">
                    <!-- åŠ¨æ€ç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨ -->
                </div>

                <div class="file-hint">
                    âš ï¸ æ–‡ä»¶å°†åœ¨3å¤©åè‡ªåŠ¨åˆ é™¤ï¼Œé‡è¦æ–‡ä»¶è¯·ä½¿ç”¨QQå‘é€
                </div>
            </div>
            <!-- æ›¿æ¢åŸæ¥çš„æ—©æ™šè¯»æ—¶é—´è®¾ç½®åŒºåŸŸ -->
            <div id="readingTimeInfo" class="file-info-area" style="display: none;">
                <div class="upload-stats">
                    <div class="stats-item">
                        <span>æ—©æ™šè¯»æ—¶é—´è®¾ç½®:</span>
                    </div>
                </div>

                <!-- æ—©æ™šè¯»ç±»å‹é€‰æ‹© -->
                <div class="form-group">
                    <label>æ—©æ™šè¯»ç±»å‹</label>
                    <div class="time-mode-selector">
                        <div class="time-mode-btn active" data-mode="morning" onclick="selectReadingType('morning')">
                            ğŸŒ… æ—©è¯»
                            <div class="time-hint">7:20 å¼€å§‹</div>
                        </div>
                        <div class="time-mode-btn" data-mode="evening" onclick="selectReadingType('evening')">
                            ğŸŒ™ æ™šè¯»
                            <div class="time-hint">18:00 å¼€å§‹</div>
                        </div>
                        <div class="time-mode-btn" data-mode="custom" onclick="selectReadingType('custom')">
                            âš™ï¸ è‡ªå®šä¹‰
                            <div class="time-hint">è‡ªå®šä¹‰å¼€å§‹æ—¶é—´</div>
                        </div>
                    </div>
                </div>

                <!-- è‡ªå®šä¹‰æ—¶é—´è®¾ç½® -->
                <div id="readingCustomTime" class="time-settings-section" style="display: none;">
                    <div class="form-group">
                        <label>è‡ªå®šä¹‰å¼€å§‹æ—¶é—´ï¼ˆ24å°æ—¶åˆ¶ï¼‰</label>
                        <div class="datetime-inputs">
                            <select id="readingCustomHour" class="time-input">
                                <option value="">æ—¶</option>
                                <!-- å°æ—¶é€‰é¡¹å°†é€šè¿‡JSç”Ÿæˆ -->
                            </select>
                            <select id="readingCustomMinute" class="time-input">
                                <option value="">åˆ†</option>
                                <!-- åˆ†é’Ÿé€‰é¡¹å°†é€šè¿‡JSç”Ÿæˆ -->
                            </select>
                            <select id="readingCustomSecond" class="time-input">
                                <option value="">ç§’</option>
                                <!-- ç§’é’Ÿé€‰é¡¹å°†é€šè¿‡JSç”Ÿæˆ -->
                            </select>
                        </div>
                    </div>
                </div>

                <!-- è‡ªåŠ¨æ‰“å¼€æ–‡ä»¶è®¾ç½® -->
                <div class="form-group">
                    <label>åˆ°æ—¶é—´è‡ªåŠ¨æ‰“å¼€æ–‡ä»¶/å›¾ç‰‡</label>
                    <div id="readingAutoOpenFiles" class="item-selection-section">
                        <!-- åŠ¨æ€ç”Ÿæˆçš„æ–‡ä»¶å’Œå›¾ç‰‡é€‰æ‹© -->
                    </div>
                    <div class="time-hint">å‹¾é€‰çš„æ–‡ä»¶å’Œå›¾ç‰‡å°†åœ¨å¼€å§‹æ—¶é—´è‡ªåŠ¨æ‰“å¼€ï¼ˆå®¢æˆ·ç«¯åŠŸèƒ½ï¼‰</div>
                </div>

                <button class="btn" onclick="applyReadingTimeSettings()" style="margin-top: 15px;">
                    âœ… åº”ç”¨æ—¶é—´è®¾ç½®
                </button>
            </div>
            <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
            <input type="file" id="readingFileInput" multiple style="display: none;"
                   onchange="handleFileUpload('reading', this.files)">

            <div class="form-group">
                <input type="text" id="readingTitle" class="form-control" placeholder="æ—©æ™šè¯»æ ‡é¢˜/ç§‘ç›®">
            </div>

            <div class="form-group">
                <label>å†…å®¹å®‰æ’</label>
                <div class="items-list" id="readingItems">
                    <!-- åŠ¨æ€ç”Ÿæˆçš„æ¡ç›® -->
                </div>
                <button class="add-btn" onclick="addReadingItem()">+ æ·»åŠ æ¡ç›®</button>
            </div>

            <div class="template-section">
                <label>æ¨¡æ¿ç®¡ç†</label>
                <div class="template-buttons">
                    <button class="template-btn save-template" onclick="saveReadingTemplate()">ä¿å­˜æ¨¡æ¿</button>
                    <button class="template-btn load-template" onclick="loadReadingTemplate()">åŠ è½½æ¨¡æ¿</button>
                </div>
            </div>

            <button class="btn btn-reading" onclick="publishReading()">å‘å¸ƒæ—©æ™šè¯»</button>
            <button class="btn btn-secondary" onclick="closeModal('readingModal')">å–æ¶ˆ</button>

            <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
            <input type="file" id="readingImageInput" accept="image/*" multiple style="display: none;"
                   onchange="handleImageUpload('reading', this.files)">
        </div>
    </div>

    <!-- å‘å¸ƒé‡è¦æ¶ˆæ¯æ¨¡æ€æ¡† -->
    <div id="importantModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">å‘å¸ƒé‡è¦æ¶ˆæ¯</h3>
                <button class="close-btn" onclick="closeModal('importantModal')">Ã—</button>
            </div>

            <div class="form-group">
                <input type="text" id="importantTitle" class="form-control" placeholder="æ¶ˆæ¯æ ‡é¢˜">
            </div>

            <div class="form-group">
                <label>æ¶ˆæ¯å†…å®¹ï¼ˆæ¯è¡Œä¸€æ¡ï¼‰</label>
                <div class="items-list" id="importantItems">
                    <!-- åŠ¨æ€ç”Ÿæˆçš„æ¡ç›® -->
                </div>
                <button class="add-btn" onclick="addImportantItem()">+ æ·»åŠ æ¡ç›®</button>
            </div>

            <div class="template-section">
                <label>æ¨¡æ¿ç®¡ç†</label>
                <div class="template-buttons">
                    <button class="template-btn save-template" onclick="saveImportantTemplate()">ä¿å­˜æ¨¡æ¿</button>
                    <button class="template-btn load-template" onclick="loadImportantTemplate()">åŠ è½½æ¨¡æ¿</button>
                </div>
            </div>

            <button class="btn btn-important" onclick="publishImportant()">å‘å¸ƒé‡è¦æ¶ˆæ¯</button>
            <button class="btn btn-secondary" onclick="closeModal('importantModal')">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- æ¶ˆæ¯æç¤º -->
    <div id="toast" class="toast"></div>

    <script>
        // åˆå§‹åŒ– LeanCloud
        const APP_ID = 'qUmcbO6SrqiCqp9iyY4xXFIQ-gzGzoHsz';
        const APP_KEY = 't3XBdjkUPITzsMYwAo3KC15s';
        const SERVER_URL = 'https://qumcbo6s.lc-cn-n1-shared.com';

        AV.init({
            appId: APP_ID,
            appKey: APP_KEY,
            serverURLs: SERVER_URL
        });

        let currentUser = null;
        let currentModalType = '';

        // æ£€æŸ¥ç™»å½•çŠ¶æ€å’Œæƒé™
        async function checkLoginStatus() {
            const user = AV.User.current();
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            try {
                const userQuery = new AV.Query('_User');
                currentUser = await userQuery.get(user.id);
                const isAdmin = currentUser.get('isAdmin') || false;
                const isSuperAdmin = currentUser.get('username') === 'Lan';

                if (!isAdmin && !isSuperAdmin) {
                    showToast('æ— æƒé™è®¿é—®æ­¤é¡µé¢', 'error');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                    return;
                }

                updateTime();
                setInterval(updateTime, 1000);

            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                showToast('åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢');
            }
        }

        // è¿”å›ä¸»é¡µ
        function goBack() {
            window.location.href = 'index.html';
        }

        // æ›´æ–°æ—¶é—´
        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent =
                `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
        }

        // æ˜¾ç¤ºæ¶ˆæ¯æç¤º
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // æ‰“å¼€ä½œä¸šæ¨¡æ€æ¡†
     

        // åˆå§‹åŒ–ä½œä¸šæ¡ç›®
        function initHomeworkItems() {
            const container = document.getElementById('homeworkItems');
            container.innerHTML = '';
            addHomeworkItem(); // é»˜è®¤æ·»åŠ ä¸€ä¸ªç©ºæ¡ç›®
        }

        // æ·»åŠ ä½œä¸šæ¡ç›®
        function addHomeworkItem() {
            const container = document.getElementById('homeworkItems');
            const itemCount = container.children.length + 1;

            const itemRow = document.createElement('div');
            itemRow.className = 'item-row';
            itemRow.innerHTML = `
                            <div class="item-number">${itemCount}.</div>
                            <input type="text" class="item-input" placeholder="ä½œä¸šå†…å®¹ ${itemCount}">
                            <button class="remove-btn" onclick="removeItem(this)">åˆ é™¤</button>
                        `;
            container.appendChild(itemRow);
        }

   

        // åˆå§‹åŒ–æ—©æ™šè¯»æ¡ç›®
        function initReadingItems() {
            const container = document.getElementById('readingItems');
            container.innerHTML = '';
            addReadingItem(); // é»˜è®¤æ·»åŠ ä¸€ä¸ªç©ºæ¡ç›®
        }

        // æ·»åŠ æ—©æ™šè¯»æ¡ç›®
        function addReadingItem() {
            const container = document.getElementById('readingItems');
            const itemCount = container.children.length + 1;

            const itemRow = document.createElement('div');
            itemRow.className = 'item-row';
            itemRow.innerHTML = `
                <div class="item-number">${itemCount}.</div>
                <input type="text" class="item-input" placeholder="é˜…è¯»å†…å®¹ ${itemCount}">
                <input type="text" class="time-input" placeholder="è¿›è¡Œæ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰" onblur="formatTimeInput(this)">
                <button class="remove-btn" onclick="removeItem(this)">åˆ é™¤</button>
            `;
            container.appendChild(itemRow);
        }

        // æ ¼å¼åŒ–æ—¶é—´è¾“å…¥
        // å¢å¼ºçš„æ—¶é—´è¾“å…¥å¤„ç†
        function formatTimeInput(input) {
            let value = input.value.trim();

            if (!value) return;

            // å¤„ç†å„ç§è¾“å…¥æ ¼å¼
            if (/^\d+$/.test(value)) {
                // çº¯æ•°å­—ï¼š20 â†’ 20åˆ†é’Ÿ
                input.value = value + 'åˆ†é’Ÿ';
            } else if (/^\d+[åˆ†]?$/.test(value)) {
                // æ•°å­—+åˆ†ï¼š20åˆ† â†’ 20åˆ†é’Ÿ
                value = value.replace('åˆ†', '');
                input.value = value + 'åˆ†é’Ÿ';
            } else if (/^\d+min$/.test(value.toLowerCase())) {
                // æ•°å­—+minï¼š20min â†’ 20åˆ†é’Ÿ
                value = value.replace(/min/gi, '');
                input.value = value + 'åˆ†é’Ÿ';
            } else if (/^\d+åˆ†é’Ÿ$/.test(value)) {
                // å·²ç»æ˜¯æ­£ç¡®æ ¼å¼ï¼Œä¸åšå¤„ç†
                return;
            } else {
                // å…¶ä»–æ ¼å¼ï¼Œæç¤ºç”¨æˆ·
                showToast('è¯·è¾“å…¥æ•°å­—æˆ–"æ•°å­—+åˆ†é’Ÿ"ï¼Œå¦‚ï¼š20 æˆ– 30åˆ†é’Ÿ', 'error');
                input.focus();
            }
        }

        // åœ¨è¾“å…¥æ—¶å®æ—¶æç¤º

        // æ›´ç®€æ´çš„æ—¶é—´è¾“å…¥æç¤ºæ–¹æ¡ˆ
        function setupTimeInputEvents() {
            // ä¸ºæ‰€æœ‰ç°æœ‰çš„æ—¶é—´è¾“å…¥æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬
            document.addEventListener('focusin', function (e) {
                if (e.target.classList.contains('time-input')) {
                    showTimeHint(e.target);
                }
            });

            document.addEventListener('input', function (e) {
                if (e.target.classList.contains('time-input')) {
                    showTimeHint(e.target);
                }
            });

            document.addEventListener('focusout', function (e) {
                if (e.target.classList.contains('time-input')) {
                    hideTimeHint(e.target);
                }
            });
        }

        function showTimeHint(input) {
            const value = input.value.trim();
            const parent = input.parentNode;

            // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§æç¤º
            hideTimeHint(input);

            // å¦‚æœæ˜¯çº¯æ•°å­—ä¸”ä¸ä¸ºç©ºï¼Œæ˜¾ç¤ºæç¤º
            if (/^\d+$/.test(value) && value.length > 0) {
                const hint = document.createElement('div');
                hint.className = 'time-hint';
                hint.textContent = 'å°†è‡ªåŠ¨æ·»åŠ "åˆ†é’Ÿ"å•ä½';
                parent.appendChild(hint);
            }
        }

        function hideTimeHint(input) {
            const parent = input.parentNode;
            const hint = parent.querySelector('.time-hint');
            if (hint) {
                hint.remove();
            }
        }

      
        // æ‰“å¼€å¬å”¤åŒå­¦æ¨¡æ€æ¡†
        function openCallModal() {
            document.getElementById('callModal').style.display = 'block';
        }

        // æ‰“å¼€é‡è¦æ¶ˆæ¯æ¨¡æ€æ¡†
        function openImportantModal() {
            currentModalType = 'important';
            document.getElementById('importantTitle').value = '';
            initImportantItems();
            document.getElementById('importantModal').style.display = 'block';
        }

        // åˆå§‹åŒ–é‡è¦æ¶ˆæ¯æ¡ç›®
        function initImportantItems() {
            const container = document.getElementById('importantItems');
            container.innerHTML = '';
            addImportantItem(); // é»˜è®¤æ·»åŠ ä¸€ä¸ªç©ºæ¡ç›®
        }

        // æ·»åŠ é‡è¦æ¶ˆæ¯æ¡ç›®
        function addImportantItem() {
            const container = document.getElementById('importantItems');
            const itemCount = container.children.length + 1;

            const itemRow = document.createElement('div');
            itemRow.className = 'item-row';
            itemRow.innerHTML = `
                            <div class="item-number">${itemCount}.</div>
                            <input type="text" class="item-input" placeholder="æ¶ˆæ¯å†…å®¹ ${itemCount}">
                            <button class="remove-btn" onclick="removeItem(this)">åˆ é™¤</button>
                        `;
            container.appendChild(itemRow);
        }

        // åˆ é™¤æ¡ç›®
        function removeItem(button) {
            const itemRow = button.parentElement;
            itemRow.remove();
            // é‡æ–°ç¼–å·
            renumberItems();
        }

        // é‡æ–°ç¼–å·æ¡ç›®
        function renumberItems() {
            const containers = ['homeworkItems', 'readingItems', 'importantItems'];
            containers.forEach(containerId => {
                const container = document.getElementById(containerId);
                if (container) {
                    const items = container.querySelectorAll('.item-row');
                    items.forEach((item, index) => {
                        const numberDiv = item.querySelector('.item-number');
                        if (numberDiv) {
                            numberDiv.textContent = `${index + 1}.`;
                        }
                    });
                }
            });
        }

        // ä¿å­˜ä½œä¸šæ¨¡æ¿åˆ°æœ¬åœ°å­˜å‚¨
        function saveHomeworkTemplate() {
            const title = document.getElementById('homeworkTitle').value;
            const items = Array.from(document.querySelectorAll('#homeworkItems .item-input'))
                .map(input => input.value)
                .filter(value => value.trim() !== '');

            const template = { title, items };
            localStorage.setItem('homeworkTemplate', JSON.stringify(template));
            showToast('ä½œä¸šæ¨¡æ¿å·²ä¿å­˜', 'success');
        }

        // åŠ è½½ä½œä¸šæ¨¡æ¿
        function loadHomeworkTemplate() {
            const templateStr = localStorage.getItem('homeworkTemplate');
            if (!templateStr) {
                showToast('æ²¡æœ‰æ‰¾åˆ°ä¿å­˜çš„æ¨¡æ¿', 'error');
                return;
            }

            try {
                const template = JSON.parse(templateStr);
                document.getElementById('homeworkTitle').value = template.title || '';

                const container = document.getElementById('homeworkItems');
                container.innerHTML = '';

                template.items.forEach((item, index) => {
                    const itemRow = document.createElement('div');
                    itemRow.className = 'item-row';
                    itemRow.innerHTML = `
                                    <div class="item-number">${index + 1}.</div>
                                    <input type="text" class="item-input" value="${item}">
                                    <button class="remove-btn" onclick="removeItem(this)">åˆ é™¤</button>
                                `;
                    container.appendChild(itemRow);
                });

                showToast('ä½œä¸šæ¨¡æ¿å·²åŠ è½½', 'success');
            } catch (error) {
                showToast('åŠ è½½æ¨¡æ¿å¤±è´¥', 'error');
            }
        }

        // ä¿å­˜æ—©æ™šè¯»æ¨¡æ¿
        function saveReadingTemplate() {
            const title = document.getElementById('readingTitle').value;
            const items = Array.from(document.querySelectorAll('#readingItems .item-row')).map(row => {
                const content = row.querySelector('.item-input').value;
                const time = row.querySelector('.time-input').value;
                return { content, time };
            }).filter(item => item.content.trim() !== '');

            const template = { title, items };
            localStorage.setItem('readingTemplate', JSON.stringify(template));
            showToast('æ—©æ™šè¯»æ¨¡æ¿å·²ä¿å­˜', 'success');
        }

        // åŠ è½½æ—©æ™šè¯»æ¨¡æ¿
        function loadReadingTemplate() {
            const templateStr = localStorage.getItem('readingTemplate');
            if (!templateStr) {
                showToast('æ²¡æœ‰æ‰¾åˆ°ä¿å­˜çš„æ¨¡æ¿', 'error');
                return;
            }

            try {
                const template = JSON.parse(templateStr);
                document.getElementById('readingTitle').value = template.title || '';

                const container = document.getElementById('readingItems');
                container.innerHTML = '';

                template.items.forEach((item, index) => {
                    const itemRow = document.createElement('div');
                    itemRow.className = 'item-row';
                    itemRow.innerHTML = `
                        <div class="item-number">${index + 1}.</div>
                        <input type="text" class="item-input" value="${item.content}">
                        <input type="text" class="time-input" value="${item.time || ''}" placeholder="è¿›è¡Œæ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰" onblur="formatTimeInput(this)">
                        <button class="remove-btn" onclick="removeItem(this)">åˆ é™¤</button>
                    `;
                    container.appendChild(itemRow);
                });

                showToast('æ—©æ™šè¯»æ¨¡æ¿å·²åŠ è½½', 'success');
            } catch (error) {
                showToast('åŠ è½½æ¨¡æ¿å¤±è´¥', 'error');
            }
        }

        // ä¿å­˜é‡è¦æ¶ˆæ¯æ¨¡æ¿
        function saveImportantTemplate() {
            const title = document.getElementById('importantTitle').value;
            const items = Array.from(document.querySelectorAll('#importantItems .item-input'))
                .map(input => input.value)
                .filter(value => value.trim() !== '');

            const template = { title, items };
            localStorage.setItem('importantTemplate', JSON.stringify(template));
            showToast('é‡è¦æ¶ˆæ¯æ¨¡æ¿å·²ä¿å­˜', 'success');
        }

        // åŠ è½½é‡è¦æ¶ˆæ¯æ¨¡æ¿
        function loadImportantTemplate() {
            const templateStr = localStorage.getItem('importantTemplate');
            if (!templateStr) {
                showToast('æ²¡æœ‰æ‰¾åˆ°ä¿å­˜çš„æ¨¡æ¿', 'error');
                return;
            }

            try {
                const template = JSON.parse(templateStr);
                document.getElementById('importantTitle').value = template.title || '';

                const container = document.getElementById('importantItems');
                container.innerHTML = '';

                template.items.forEach((item, index) => {
                    const itemRow = document.createElement('div');
                    itemRow.className = 'item-row';
                    itemRow.innerHTML = `
                                    <div class="item-number">${index + 1}.</div>
                                    <input type="text" class="item-input" value="${item}">
                                    <button class="remove-btn" onclick="removeItem(this)">åˆ é™¤</button>
                                `;
                    container.appendChild(itemRow);
                });

                showToast('é‡è¦æ¶ˆæ¯æ¨¡æ¿å·²åŠ è½½', 'success');
            } catch (error) {
                showToast('åŠ è½½æ¨¡æ¿å¤±è´¥', 'error');
            }
        }

    

        // å‘å¸ƒé‡è¦æ¶ˆæ¯
        async function publishImportant() {
            const title = document.getElementById('importantTitle').value;
            const items = Array.from(document.querySelectorAll('#importantItems .item-input'))
                .map(input => input.value)
                .filter(value => value.trim() !== '');

            if (!title || items.length === 0) {
                showToast('è¯·å¡«å†™æ ‡é¢˜å’Œè‡³å°‘ä¸€æ¡æ¶ˆæ¯å†…å®¹', 'error');
                return;
            }

            try {
                const content = items.map((item, index) => `${index + 1}. ${item}`).join('\n');

                const Notice = AV.Object.extend('Notice');
                const notice = new Notice();
                notice.set('title', `ã€é‡è¦ã€‘${title}`);
                notice.set('content', content);
                notice.set('author', currentUser.get('username'));
                notice.set('type', 'important');

                await notice.save();
                showToast('é‡è¦æ¶ˆæ¯å‘å¸ƒæˆåŠŸï¼', 'success');
                closeModal('importantModal');

            } catch (error) {
                console.error('å‘å¸ƒå¤±è´¥:', error);
                showToast('å‘å¸ƒå¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        document.addEventListener('DOMContentLoaded', checkLoginStatus);

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function (event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // GitHub é…ç½®
        const GITHUB_TOKEN = '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';
        const GITHUB_REPO = 'LHblbsl/22classfile'; // éœ€è¦æ›¿æ¢ä¸ºå®é™…å€¼
        const GITHUB_BRANCH = 'main';

        // ä¸Šä¼ æ–‡ä»¶åˆ° GitHub
        async function uploadToGitHub(file, type, onProgress) {
            return new Promise(async (resolve, reject) => {
                try {
                    // ç”Ÿæˆå”¯ä¸€æ–‡ä»¶åï¼šæ—¶é—´æˆ³ + éšæœºæ•°
                    const timestamp = Date.now();
                    const random = Math.random().toString(36).substring(2, 8);
                    const fileExtension = file.name.split('.').pop();
                    const uniqueFileName = `${type}_${timestamp}_${random}.${fileExtension}`;
                    const filePath = `uploads/${type}/${uniqueFileName}`;

                    // è¯»å–æ–‡ä»¶å†…å®¹
                    const reader = new FileReader();

                    reader.onload = async function (e) {
                        try {
                            const content = btoa(new Uint8Array(e.target.result).reduce(
                                (data, byte) => data + String.fromCharCode(byte), ''
                            ));

                            // æ¨¡æ‹Ÿä¸Šä¼ è¿›åº¦
                            let progress = 0;
                            const progressInterval = setInterval(() => {
                                progress += 20;
                                if (onProgress) onProgress(progress);
                                if (progress >= 100) {
                                    clearInterval(progressInterval);
                                }
                            }, 200);

                            // åˆ›å»º GitHub API è¯·æ±‚
                            const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${filePath}`, {
                                method: 'PUT',
                                headers: {
                                    'Authorization': `token ${GITHUB_TOKEN}`,
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    message: `Upload ${file.name} as ${uniqueFileName}`,
                                    content: content,
                                    branch: GITHUB_BRANCH
                                })
                            });

                            if (!response.ok) {
                                const errorData = await response.json();
                                throw new Error(errorData.message || 'ä¸Šä¼ å¤±è´¥');
                            }

                            const result = await response.json();
                            resolve({
                                url: result.content.download_url,
                                name: file.name, // åŸå§‹æ–‡ä»¶å
                                uniqueName: uniqueFileName, // é‡å‘½ååçš„æ–‡ä»¶å
                                size: file.size,
                                githubPath: filePath
                            });

                        } catch (error) {
                            reject(error);
                        }
                    };

                    reader.onerror = () => reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
                    reader.readAsArrayBuffer(file);

                } catch (error) {
                    reject(error);
                }
            });
        }

        // å›¾ç‰‡å’Œæ–‡ä»¶ç®¡ç†
        let currentImages = {
            homework: [],
            reading: [],
            important: []
        };

        let currentFiles = {
            homework: [],
            reading: []
        };

        // æ·»åŠ ä¸Šä¼ ç»Ÿè®¡ç®¡ç†
        let uploadStats = {
            homework: { todayUsage: 0, maxDaily: 100 * 1024 * 1024 }, // 100MB
            reading: { todayUsage: 0, maxDaily: 100 * 1024 * 1024 }   // 100MB
        };
        function updateFileUploadText(type) {
            const uploadArea = document.getElementById(`${type}FileUpload`);
            if (uploadArea) {
                const hint = uploadArea.querySelector('.file-upload-hint');
                if (hint) {
                    hint.textContent = 'å•ä¸ªæ–‡ä»¶ä¸è¶…è¿‡100MBï¼Œä»Šæ—¥æ€»ä¸Šé™100MB';
                }
            }
        }
        // è§¦å‘å›¾ç‰‡ä¸Šä¼ 
        function triggerImageUpload(type) {
            document.getElementById(`${type}ImageInput`).click();
        }

      
        // ç§»é™¤å›¾ç‰‡
        function removeImage(type, fileName) {
            currentImages[type] = currentImages[type].filter(img => img.file.name !== fileName);
            updateImagePreview(type);
        }

        // æ›´æ–°å›¾ç‰‡é¢„è§ˆ
        function updateImagePreview(type) {
            const previewArea = document.getElementById(`${type}ImagePreview`);
            previewArea.innerHTML = '';

            if (currentImages[type].length === 0) {
                previewArea.style.display = 'none';
                return;
            }

            currentImages[type].forEach(img => {
                const imageItem = document.createElement('div');
                imageItem.className = 'image-preview-item';
                imageItem.innerHTML = `
            <img src="${img.preview}" class="image-preview" alt="é¢„è§ˆ">
            <button class="remove-image-btn" onclick="removeImage('${type}', '${img.file.name}')">Ã—</button>
        `;
                previewArea.appendChild(imageItem);
            });
            previewArea.style.display = 'block';
        }

        // è§¦å‘æ–‡ä»¶ä¸Šä¼ 
        function triggerFileUpload(type) {
            document.getElementById(`${type}FileInput`).click();
        }

        // å¤„ç†æ‹–æ‹½äº‹ä»¶
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
        }

        // å¤„ç†æ–‡ä»¶æ‹–æ”¾
        async function handleFileDrop(type, event) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');

            const files = event.dataTransfer.files;
            await handleFileUpload(type, files);
        }

        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        async function handleFileUpload(type, files) {
            const fileList = document.getElementById(`${type}FileList`);
            const stats = uploadStats[type];

            if (!fileList) {
                console.error(`æ‰¾ä¸åˆ°æ–‡ä»¶åˆ—è¡¨å…ƒç´ : ${type}FileList`);
                return;
            }

            // å¦‚æœæ²¡æœ‰æ–‡ä»¶ï¼Œç›´æ¥è¿”å›
            if (!files || files.length === 0) {
                return;
            }

            // è®¾ç½®ä¸Šä¼ çŠ¶æ€
            updateUploadStatus(type, { uploading: true, success: false, error: false });

            let uploadCount = 0;
            let totalFiles = Array.from(files).length;
            let hasError = false;

            for (const file of Array.from(files)) {
                if (file.size > 100 * 1024 * 1024) {
                    showToast(`æ–‡ä»¶ ${file.name} è¶…è¿‡100MBé™åˆ¶`, 'error');
                    uploadCount++;
                    hasError = true;
                    continue;
                }

                if (stats.todayUsage + file.size > stats.maxDaily) {
                    showToast('ä»Šæ—¥ä¸Šä¼ é¢åº¦å·²ç”¨å®Œï¼Œè¯·ä½¿ç”¨QQå‘é€æ–‡ä»¶', 'error');
                    uploadCount++;
                    hasError = true;
                    continue;
                }

                const fileId = Date.now() + Math.random();
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
            <div class="file-info">
                <div class="file-icon">ğŸ“„</div>
                <div class="file-details">
                    <div class="file-name">${file.name}</div>
                    <div class="file-size">${formatFileSize(file.size)}</div>
                    <div class="upload-progress">
                        <div class="progress-bar" id="progress-${fileId}"></div>
                    </div>
                    <div class="progress-text" id="progress-text-${fileId}">å‡†å¤‡ä¸Šä¼ ...</div>
                </div>
            </div>
            <button class="file-remove" onclick="removeFile('${type}', '${fileId}')">åˆ é™¤</button>
        `;
                fileList.appendChild(fileItem);

                const progressBar = document.getElementById(`progress-${fileId}`);
                const progressText = document.getElementById(`progress-text-${fileId}`);
                progressBar.parentElement.style.display = 'block';

                try {
                    const result = await uploadToGitHub(file, 'files', (progress) => {
                        progressBar.style.width = `${progress}%`;
                        progressText.textContent = `ä¸Šä¼ ä¸­... ${progress}%`;
                        if (progress === 100) {
                            progressText.textContent = 'ä¸Šä¼ å®Œæˆï¼Œç­‰å¾…ç¡®è®¤...';
                        }
                    });

                    // ä¸Šä¼ æˆåŠŸï¼Œæ›´æ–°è¿›åº¦æ¡ä¸ºç»¿è‰²
                    progressBar.style.background = 'linear-gradient(135deg, #00b894, #00a085)';
                    progressText.textContent = 'ä¸Šä¼ æˆåŠŸ';
                    progressText.style.color = '#00b894';

                    // ä¿å­˜æ–‡ä»¶ä¿¡æ¯
                    currentFiles[type].push({
                        id: fileId,
                        file: file,
                        uploadTime: new Date(),
                        githubUrl: result.url,
                        name: result.name,
                        uniqueName: result.uniqueName,
                        size: file.size
                    });

                    stats.todayUsage += file.size;
                    updateUploadStats(type);

                    showToast(`æ–‡ä»¶ ${file.name} ä¸Šä¼ æˆåŠŸ`, 'success');

                } catch (error) {
                    console.error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥:', error);
                    progressText.textContent = 'ä¸Šä¼ å¤±è´¥';
                    progressText.style.color = '#e74c3c';
                    progressBar.style.background = '#e74c3c';
                    showToast(`æ–‡ä»¶ ${file.name} ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
                    hasError = true;
                } finally {
                    uploadCount++;
                    // æ‰€æœ‰æ–‡ä»¶å¤„ç†å®Œæˆåæ›´æ–°çŠ¶æ€
                    if (uploadCount === totalFiles) {
                        updateUploadStatus(type, {
                            uploading: false,
                            error: hasError
                        });
                    }
                }
            }
        }

        // ä¿®æ”¹å¤„ç†å›¾ç‰‡ä¸Šä¼ çš„å‡½æ•°
        async function handleImageUpload(type, files) {
            const maxSize = 10 * 1024 * 1024;
            const previewArea = document.getElementById(`${type}ImagePreview`);

            if (!currentImages[type]) {
                currentImages[type] = [];
            }

            // å¦‚æœæ²¡æœ‰æ–‡ä»¶ï¼Œç›´æ¥è¿”å›
            if (!files || files.length === 0) {
                return;
            }

            // è®¾ç½®ä¸Šä¼ çŠ¶æ€
            updateUploadStatus(type, { uploading: true, success: false, error: false });

            let uploadCount = 0;
            let totalFiles = Array.from(files).length;
            let hasError = false;

            for (const file of Array.from(files)) {
                if (file.size > maxSize) {
                    showToast(`å›¾ç‰‡ ${file.name} è¶…è¿‡10MBé™åˆ¶`, 'error');
                    uploadCount++;
                    hasError = true;
                    continue;
                }

                const reader = new FileReader();
                reader.onload = async function (e) {
                    const imageItem = document.createElement('div');
                    imageItem.className = 'image-preview-item';
                    imageItem.innerHTML = `
                <img src="${e.target.result}" class="image-preview" alt="é¢„è§ˆ">
                <div class="upload-progress">
                    <div class="progress-bar" id="image-progress-${file.name}"></div>
                </div>
                <div class="progress-text" id="image-progress-text-${file.name}">å‡†å¤‡ä¸Šä¼ ...</div>
                <button class="remove-image-btn" onclick="removeImage('${type}', '${file.name}')">Ã—</button>
            `;
                    previewArea.appendChild(imageItem);
                    previewArea.style.display = 'block';

                    const progressBar = document.getElementById(`image-progress-${file.name}`);
                    const progressText = document.getElementById(`image-progress-text-${file.name}`);
                    progressBar.parentElement.style.display = 'block';

                    try {
                        const result = await uploadToGitHub(file, 'images', (progress) => {
                            progressBar.style.width = `${progress}%`;
                            progressText.textContent = `ä¸Šä¼ ä¸­... ${progress}%`;
                            if (progress === 100) {
                                progressText.textContent = 'ä¸Šä¼ å®Œæˆï¼Œç­‰å¾…ç¡®è®¤...';
                            }
                        });

                        // ä¸Šä¼ æˆåŠŸï¼Œæ›´æ–°è¿›åº¦æ¡ä¸ºç»¿è‰²
                        progressBar.style.background = 'linear-gradient(135deg, #00b894, #00a085)';
                        progressText.textContent = 'ä¸Šä¼ æˆåŠŸ';
                        progressText.style.color = '#00b894';

                        // ä¿å­˜å›¾ç‰‡ä¿¡æ¯
                        const imageInfo = {
                            file: file,
                            preview: e.target.result,
                            uploadTime: new Date(),
                            id: Date.now() + Math.random(),
                            githubUrl: result.url,
                            name: result.name,
                            uniqueName: result.uniqueName,
                            size: file.size
                        };

                        currentImages[type].push(imageInfo);
                        console.log('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ:', imageInfo);

                        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                        showToast(`å›¾ç‰‡ ${file.name} ä¸Šä¼ æˆåŠŸ`, 'success');

                    } catch (error) {
                        console.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', error);
                        progressText.textContent = 'ä¸Šä¼ å¤±è´¥';
                        progressText.style.color = '#e74c3c';
                        progressBar.style.background = '#e74c3c';
                        showToast(`å›¾ç‰‡ ${file.name} ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
                        hasError = true;
                    } finally {
                        uploadCount++;
                        // æ‰€æœ‰æ–‡ä»¶å¤„ç†å®Œæˆåæ›´æ–°çŠ¶æ€
                        if (uploadCount === totalFiles) {
                            updateUploadStatus(type, {
                                uploading: false,
                                error: hasError
                            });
                        }
                    }
                };
                reader.readAsDataURL(file);
            }
        }


        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        // ç§»é™¤æ–‡ä»¶
        function removeFile(type, fileId) {
            const fileIndex = currentFiles[type].findIndex(f => f.id == fileId);
            if (fileIndex !== -1) {
                const file = currentFiles[type][fileIndex];
                // æ¢å¤é¢åº¦
                uploadStats[type].todayUsage -= file.file.size;
                updateUploadStats(type);

                // ä»æ•°ç»„ä¸­ç§»é™¤
                currentFiles[type].splice(fileIndex, 1);

                // ä»UIç§»é™¤
                const fileItems = document.querySelectorAll(`#${type}FileList .file-item`);
                fileItems.forEach(item => {
                    const removeBtn = item.querySelector('.file-remove');
                    if (removeBtn && removeBtn.getAttribute('onclick').includes(fileId)) {
                        item.remove();
                    }
                });
            }
        }

        // æ›´æ–°ä¸Šä¼ ç»Ÿè®¡æ˜¾ç¤º
        function updateUploadStats(type) {
            const stats = uploadStats[type];
            const remaining = Math.max(0, stats.maxDaily - stats.todayUsage);

            // å®‰å…¨åœ°æ›´æ–°DOMå…ƒç´ 
            const todayUsageEl = document.getElementById(`${type}TodayUsage`);
            const remainingEl = document.getElementById(`${type}Remaining`);

            if (todayUsageEl) {
                todayUsageEl.textContent = `${(stats.todayUsage / 1024 / 1024).toFixed(2)}MB / 30MB`;
            }

            if (remainingEl) {
                remainingEl.textContent = `${(remaining / 1024 / 1024).toFixed(2)}MB`;
            }
        }

        // é‡ç½®æ–‡ä»¶ä¸Šä¼ çŠ¶æ€ï¼ˆæ¯å¤©é‡ç½®ï¼‰
        function resetDailyUploadStats() {
            const today = new Date().toDateString();
            const lastReset = localStorage.getItem('lastUploadReset');

            if (lastReset !== today) {
                uploadStats.homework.todayUsage = 0;
                uploadStats.reading.todayUsage = 0;
                localStorage.setItem('lastUploadReset', today);

                // æ›´æ–°æ˜¾ç¤º
                updateUploadStats('homework');
                updateUploadStats('reading');
            }
        }

        // ä¿®æ”¹æ˜¾ç¤ºæ–‡ä»¶è®¾ç½®çš„å‡½æ•°
        function showFileSettings(type) {
            const fileInfo = document.getElementById(`${type}FileInfo`);
            if (fileInfo) {
                if (fileInfo.style.display === 'none' || !fileInfo.style.display) {
                    fileInfo.style.display = 'block';
                    resetDailyUploadStats();
                    updateUploadStats(type);
                } else {
                    fileInfo.style.display = 'none';
                }
            }
        }
        // è·³è½¬åˆ°å­¦ç”Ÿå¬å”¤é¡µé¢
        function goToStudentSummon() {
            window.location.href = 'student-summon.html';
        }
        // ä¿®æ”¹æ¨¡æ€æ¡†æ‰“å¼€å‡½æ•°ï¼Œåˆå§‹åŒ–æ–‡ä»¶çŠ¶æ€
        // ä¿®æ”¹æ¨¡æ€æ¡†æ‰“å¼€å‡½æ•°ï¼Œé‡ç½®ä¸Šä¼ çŠ¶æ€
        // åœ¨æ‰“å¼€ä½œä¸šæ¨¡æ€æ¡†æ—¶é‡ç½®æ—¶é—´è®¾ç½®
        function openHomeworkModal() {
            currentModalType = 'homework';
            document.getElementById('homeworkTitle').value = '';
            currentImages.homework = [];
            currentFiles.homework = [];

            // é‡ç½®æ—¶é—´è®¾ç½®
            timeSettings.homework = {
                mode: 'countdown',
                applyTo: 'all',
                countdownHours: null,
                deadline: null,
                itemDeadlines: {}
            };

            updateImagePreview('homework');
            document.getElementById('homeworkImagePreview').style.display = 'none';
            document.getElementById('homeworkFileInfo').style.display = 'none';
            document.getElementById('homeworkTimeInfo').style.display = 'none'; // ç¡®ä¿æ—¶é—´è®¾ç½®é¢æ¿å…³é—­

            const fileList = document.getElementById('homeworkFileList');
            if (fileList) fileList.innerHTML = '';
            initHomeworkItems();
            document.getElementById('homeworkModal').style.display = 'block';

            // é‡ç½®ä¸Šä¼ çŠ¶æ€
            updateUploadStatus('homework', { uploading: false, success: false, error: false });
            updateFileUploadText('homework');
        }

        function openReadingModal() {
            currentModalType = 'reading';
            document.getElementById('readingTitle').value = '';
            currentImages.reading = [];
            currentFiles.reading = [];
            updateImagePreview('reading');
            document.getElementById('readingImagePreview').style.display = 'none';
            document.getElementById('readingFileInfo').style.display = 'none';
            const fileList = document.getElementById('readingFileList');
            if (fileList) fileList.innerHTML = '';
            initReadingItems();
            document.getElementById('readingModal').style.display = 'block';

            // é‡ç½®ä¸Šä¼ çŠ¶æ€
            updateUploadStatus('reading', { uploading: false, success: false, error: false });
            updateFileUploadText('reading');
        }
        // ä¿®æ”¹å‘å¸ƒä½œä¸šå‡½æ•°ï¼ŒåŒ…å«æ—¶é—´ä¿¡æ¯
        async function publishHomework() {
            const title = document.getElementById('homeworkTitle').value;
            const items = Array.from(document.querySelectorAll('#homeworkItems .item-input'))
                .map(input => input.value)
                .filter(value => value.trim() !== '');

            if (!title || items.length === 0) {
                showToast('è¯·å¡«å†™æ ‡é¢˜å’Œè‡³å°‘ä¸€æ¡ä½œä¸šå†…å®¹', 'error');
                return;
            }

            // åªåœ¨æœ‰æ–‡ä»¶ä¸Šä¼ æ—¶æ‰æ£€æŸ¥ä¸Šä¼ çŠ¶æ€
            if (currentFiles.homework.length > 0 && uploadStatus.homework.uploading) {
                showToast('æ–‡ä»¶æ­£åœ¨ä¸Šä¼ ä¸­ï¼Œè¯·ç¨åå‘å¸ƒ', 'error');
                return;
            }

            try {
                const content = items.map((item, index) => `${index + 1}. ${item}`).join('\n');

                const Notice = AV.Object.extend('Notice');
                const notice = new Notice();
                notice.set('title', `ã€ä½œä¸šã€‘${title}`);
                notice.set('content', content);
                notice.set('author', currentUser.get('username'));
                notice.set('type', 'homework');

                // ä¿å­˜æ—¶é—´è®¾ç½®ä¿¡æ¯
                if (timeSettings.homework && Object.keys(timeSettings.homework.itemDeadlines).length > 0) {
                    const itemDeadlines = [];
                    Object.keys(timeSettings.homework.itemDeadlines).forEach(itemIndex => {
                        const deadline = timeSettings.homework.itemDeadlines[itemIndex];
                        if (deadline) {
                            itemDeadlines.push({
                                itemIndex: parseInt(itemIndex),
                                deadline: deadline.toISOString()
                            });
                        }
                    });

                    if (itemDeadlines.length > 0) {
                        notice.set('itemDeadlines', itemDeadlines);
                        console.log('ä¿å­˜æ—¶é—´è®¾ç½®:', itemDeadlines);
                    }
                }

                // ä¿å­˜æ–‡ä»¶ä¿¡æ¯
                if (currentFiles.homework.length > 0) {
                    notice.set('fileCount', currentFiles.homework.length);
                    notice.set('fileNames', currentFiles.homework.map(f => f.name));
                    notice.set('fileUrls', currentFiles.homework.map(f => f.githubUrl));
                    notice.set('fileUniqueNames', currentFiles.homework.map(f => f.uniqueName));
                }

                // ä¿å­˜å›¾ç‰‡ä¿¡æ¯
                if (currentImages.homework.length > 0) {
                    notice.set('images', currentImages.homework.map(img => img.githubUrl));
                    notice.set('imageCount', currentImages.homework.length);
                    notice.set('imageNames', currentImages.homework.map(img => img.name));
                    notice.set('imageUniqueNames', currentImages.homework.map(img => img.uniqueName));
                }

                // åªåœ¨æœ‰æ–‡ä»¶ä¸Šä¼ æ—¶æ‰ç¦ç”¨æŒ‰é’®
                if (currentFiles.homework.length > 0 || currentImages.homework.length > 0) {
                    updateUploadStatus('homework', { uploading: true });
                }

                await notice.save();
                showToast('ä½œä¸šå‘å¸ƒæˆåŠŸï¼', 'success');
                closeModal('homeworkModal');

                // é‡ç½®æ—¶é—´è®¾ç½®
                timeSettings.homework = {
                    mode: 'countdown',
                    applyTo: 'all',
                    countdownHours: null,
                    deadline: null,
                    itemDeadlines: {}
                };

            } catch (error) {
                console.error('å‘å¸ƒå¤±è´¥:', error);
                showToast('å‘å¸ƒå¤±è´¥ï¼š' + error.message, 'error');
            } finally {
                // é‡æ–°å¯ç”¨å‘å¸ƒæŒ‰é’®
                updateUploadStatus('homework', { uploading: false });
            }
        }
      
        // é‡ç½®ä½œä¸šè¡¨å•
        function resetHomeworkForm() {
            document.getElementById('homeworkTitle').value = '';
            currentImages.homework = [];
            currentFiles.homework = [];
            updateImagePreview('homework');
            document.getElementById('homeworkImagePreview').style.display = 'none';
            document.getElementById('homeworkFileInfo').style.display = 'none';
            const fileList = document.getElementById('homeworkFileList');
            if (fileList) fileList.innerHTML = '';
            initHomeworkItems();
        }

      

        // åœ¨é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function () {
            checkLoginStatus();
            resetDailyUploadStats();
            setupTimeInputEvents(); // ç¡®ä¿æ—¶é—´è¾“å…¥äº‹ä»¶å·²è®¾ç½®
        });
        // æ—¶é—´è®¾ç½®ç›¸å…³å˜é‡
        let timeSettings = {
            homework: {
                mode: 'countdown',
                applyTo: 'all',
                countdownHours: null,
                deadline: null,
                itemDeadlines: {}
            }
        };

        function selectTimeMode(type, mode) {
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const buttons = document.querySelectorAll(`#${type}TimeInfo .time-mode-btn`);
            buttons.forEach(btn => {
                if (btn.dataset.mode === mode) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // æ˜¾ç¤ºå¯¹åº”çš„è®¾ç½®åŒºåŸŸ
            const countdownSection = document.getElementById(`${type}CountdownSettings`);
            const datetimeSection = document.getElementById(`${type}DatetimeSettings`);

            if (mode === 'countdown') {
                countdownSection.style.display = 'block';
                datetimeSection.style.display = 'none';
            } else {
                countdownSection.style.display = 'none';
                datetimeSection.style.display = 'block';
            }

            timeSettings[type].mode = mode;
        }

        function initItemSelection(type) {
            const container = document.getElementById(`${type}TimeItems`);
            const itemsContainer = document.getElementById(`${type}Items`);

            if (container && itemsContainer) {
                container.innerHTML = '';
                const items = itemsContainer.querySelectorAll('.item-row');

                items.forEach((item, index) => {
                    const input = item.querySelector('.item-input');
                    if (input) {
                        const checkbox = document.createElement('div');
                        checkbox.className = 'time-item-checkbox';
                        const content = input.value.trim() || `æ¡ç›® ${index + 1}`;
                        checkbox.innerHTML = `
                    <input type="checkbox" id="timeItem${index}" checked>
                    <div class="item-number">${index + 1}.</div>
                    <div class="item-content-preview" title="${content}">${content}</div>
                `;
                        container.appendChild(checkbox);
                    }
                });

                // å¦‚æœæ²¡æœ‰æ¡ç›®ï¼Œæ˜¾ç¤ºæç¤º
                if (container.children.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">æš‚æ— ä½œä¸šæ¡ç›®</div>';
                }
            }
        }
        // æ˜¾ç¤ºæ—¶é—´è®¾ç½®
        function showTimeSettings(type) {
            const timeInfo = document.getElementById(`${type}TimeInfo`);
            if (timeInfo) {
                if (timeInfo.style.display === 'none' || !timeInfo.style.display) {
                    timeInfo.style.display = 'block';
                    initTimeSettings(type);
                } else {
                    timeInfo.style.display = 'none';
                }
            }
        }

        // åˆå§‹åŒ–æ—¶é—´è®¾ç½®
        function initTimeSettings(type) {
            // åˆå§‹åŒ–æœˆä»½é€‰é¡¹
            initMonthOptions(type);
            // åˆå§‹åŒ–æ—¥æœŸé€‰é¡¹
            initDayOptions(type);
            // åˆå§‹åŒ–å°æ—¶é€‰é¡¹
            initHourOptions(type);
            // åˆå§‹åŒ–æ¡ç›®é€‰æ‹©
            initItemSelection(type);
        }

        // åˆå§‹åŒ–æœˆä»½é€‰é¡¹
        function initMonthOptions(type) {
            const monthSelect = document.getElementById(`${type}DeadlineMonth`);
            if (monthSelect) {
                monthSelect.innerHTML = '<option value="">æœˆ</option>';
                for (let i = 1; i <= 12; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${i}æœˆ`;
                    monthSelect.appendChild(option);
                }
            }
        }

        // åˆå§‹åŒ–æ—¥æœŸé€‰é¡¹
        function initDayOptions(type) {
            const daySelect = document.getElementById(`${type}DeadlineDay`);
            if (daySelect) {
                daySelect.innerHTML = '<option value="">æ—¥</option>';
                for (let i = 1; i <= 31; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${i}æ—¥`;
                    daySelect.appendChild(option);
                }
            }
        }

        // åˆå§‹åŒ–å°æ—¶é€‰é¡¹
        function initHourOptions(type) {
            const hourSelect = document.getElementById(`${type}DeadlineHour`);
            if (hourSelect) {
                hourSelect.innerHTML = '<option value="">æ—¶</option>';
                for (let i = 0; i < 24; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${i.toString().padStart(2, '0')}æ—¶`;
                    hourSelect.appendChild(option);
                }
            }
        }

        // åˆå§‹åŒ–æ¡ç›®é€‰æ‹©
        function initItemSelection(type) {
            const container = document.getElementById(`${type}TimeItems`);
            const itemsContainer = document.getElementById(`${type}Items`);

            if (container && itemsContainer) {
                container.innerHTML = '';
                const items = itemsContainer.querySelectorAll('.item-row');

                items.forEach((item, index) => {
                    const input = item.querySelector('.item-input');
                    if (input && input.value.trim()) {
                        const checkbox = document.createElement('div');
                        checkbox.className = 'time-item-checkbox';
                        checkbox.innerHTML = `
                    <input type="checkbox" id="timeItem${index}" checked>
                    <label for="timeItem${index}">${input.value}</label>
                `;
                        container.appendChild(checkbox);
                    }
                });
            }
        }

        // åˆ‡æ¢æ—¶é—´æ¨¡å¼
        function changeTimeMode(type) {
            const mode = document.getElementById(`${type}TimeMode`).value;
            const countdownSection = document.getElementById(`${type}CountdownSettings`);
            const datetimeSection = document.getElementById(`${type}DatetimeSettings`);

            if (mode === 'countdown') {
                countdownSection.style.display = 'block';
                datetimeSection.style.display = 'none';
            } else {
                countdownSection.style.display = 'none';
                datetimeSection.style.display = 'block';
            }

            timeSettings[type].mode = mode;
        }

        // åˆ‡æ¢åº”ç”¨èŒƒå›´
        function changeApplyTo(type) {
            const applyTo = document.getElementById(`${type}TimeApply`).value;
            const selectionSection = document.getElementById(`${type}ItemSelection`);

            if (applyTo === 'selected') {
                selectionSection.style.display = 'block';
                initItemSelection(type);
            } else {
                selectionSection.style.display = 'none';
            }

            timeSettings[type].applyTo = applyTo;
        }
        // åº”ç”¨æ—¶é—´è®¾ç½®
        function applyTimeSettings(type) {
            const mode = timeSettings[type].mode;

            if (mode === 'countdown') {
                const hours = parseFloat(document.getElementById(`${type}CountdownHours`).value);
                if (!hours || hours <= 0) {
                    showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„å‰©ä½™æ—¶é—´', 'error');
                    return;
                }

                const deadline = new Date(Date.now() + hours * 60 * 60 * 1000);

                // è·å–é€‰ä¸­çš„æ¡ç›®
                const selectedItems = getSelectedTimeItems(type);
                if (selectedItems.length === 0) {
                    showToast('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªä½œä¸šæ¡ç›®', 'error');
                    return;
                }

                // ä¸ºé€‰ä¸­çš„æ¡ç›®è®¾ç½®æ—¶é—´
                selectedItems.forEach(itemIndex => {
                    timeSettings[type].itemDeadlines[itemIndex] = deadline;
                });

                showToast(`å·²ä¸º ${selectedItems.length} ä¸ªæ¡ç›®è®¾ç½®æˆªæ­¢æ—¶é—´`, 'success');

            } else {
                const month = document.getElementById(`${type}DeadlineMonth`).value;
                const day = document.getElementById(`${type}DeadlineDay`).value;
                const hour = document.getElementById(`${type}DeadlineHour`).value;

                if (!month || !day || !hour) {
                    showToast('è¯·é€‰æ‹©å®Œæ•´çš„æ—¥æœŸå’Œæ—¶é—´', 'error');
                    return;
                }

                const now = new Date();
                const year = now.getFullYear();
                const deadline = new Date(year, month - 1, day, hour);

                // å¦‚æœé€‰æ‹©çš„æ—¶é—´å·²ç»è¿‡å»ï¼Œå°±è®¾ç½®ä¸ºæ˜å¹´
                if (deadline <= now) {
                    deadline.setFullYear(year + 1);
                }

                // è·å–é€‰ä¸­çš„æ¡ç›®
                const selectedItems = getSelectedTimeItems(type);
                if (selectedItems.length === 0) {
                    showToast('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªä½œä¸šæ¡ç›®', 'error');
                    return;
                }

                selectedItems.forEach(itemIndex => {
                    timeSettings[type].itemDeadlines[itemIndex] = deadline;
                });

                showToast(`å·²ä¸º ${selectedItems.length} ä¸ªæ¡ç›®è®¾ç½®æˆªæ­¢æ—¶é—´`, 'success');
            }

            // å…³é—­æ—¶é—´è®¾ç½®é¢æ¿
            document.getElementById(`${type}TimeInfo`).style.display = 'none';
        }

        // è·å–é€‰ä¸­çš„æ¡ç›®ç´¢å¼•
        function getSelectedTimeItems(type) {
            const checkboxes = document.querySelectorAll(`#${type}TimeItems input[type="checkbox"]:checked`);
            return Array.from(checkboxes).map(cb => {
                const id = cb.id.replace('timeItem', '');
                return parseInt(id);
            }).filter(index => !isNaN(index));
        }

        // ä¿®æ”¹å‘å¸ƒä½œä¸šå‡½æ•°ï¼ŒåŒ…å«æ—¶é—´ä¿¡æ¯

        // è®¡ç®—å‰©ä½™æ—¶é—´
        function calculateTimeLeft(deadline) {
            const now = new Date();
            const diff = deadline - now;

            if (diff <= 0) return 'å·²æˆªæ­¢';

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            if (days > 0) {
                return `${days}å¤©${hours}æ—¶${minutes}åˆ†`;
            } else if (hours > 0) {
                return `${hours}æ—¶${minutes}åˆ†${seconds}ç§’`;
            } else {
                return `${minutes}åˆ†${seconds}ç§’`;
            }
        }

        // æ—©æ™šè¯»æ—¶é—´è®¾ç½®ç›¸å…³å˜é‡
        let readingTimeSettings = {
            type: 'morning', // morning, evening æˆ– custom
            startTime: null,
            autoOpenFiles: [],
            autoOpenImages: []
        };

        // é€‰æ‹©æ—©æ™šè¯»ç±»å‹
        function selectReadingType(type) {
            const buttons = document.querySelectorAll('#readingTimeInfo .time-mode-btn');
            buttons.forEach(btn => {
                if (btn.dataset.mode === type) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            readingTimeSettings.type = type;

            // æ˜¾ç¤º/éšè—è‡ªå®šä¹‰æ—¶é—´è®¾ç½®
            const customTimeSection = document.getElementById('readingCustomTime');
            if (type === 'custom') {
                customTimeSection.style.display = 'block';
                initCustomTimeOptions();
            } else {
                customTimeSection.style.display = 'none';

                // è®¾ç½®å¯¹åº”çš„å¼€å§‹æ—¶é—´
                if (type === 'morning') {
                    readingTimeSettings.startTime = new Date();
                    readingTimeSettings.startTime.setHours(7, 20, 0, 0);
                } else {
                    readingTimeSettings.startTime = new Date();
                    readingTimeSettings.startTime.setHours(18, 0, 0, 0);
                }
            }
        }

        // åˆå§‹åŒ–è‡ªå®šä¹‰æ—¶é—´é€‰é¡¹
        function initCustomTimeOptions() {
            // åˆå§‹åŒ–å°æ—¶é€‰é¡¹
            const hourSelect = document.getElementById('readingCustomHour');
            if (hourSelect) {
                hourSelect.innerHTML = '<option value="">æ—¶</option>';
                for (let i = 0; i < 24; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${i.toString().padStart(2, '0')}æ—¶`;
                    hourSelect.appendChild(option);
                }
            }

            // åˆå§‹åŒ–åˆ†é’Ÿé€‰é¡¹
            const minuteSelect = document.getElementById('readingCustomMinute');
            if (minuteSelect) {
                minuteSelect.innerHTML = '<option value="">åˆ†</option>';
                for (let i = 0; i < 60; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${i.toString().padStart(2, '0')}åˆ†`;
                    minuteSelect.appendChild(option);
                }
            }

            // åˆå§‹åŒ–ç§’é’Ÿé€‰é¡¹
            const secondSelect = document.getElementById('readingCustomSecond');
            if (secondSelect) {
                secondSelect.innerHTML = '<option value="">ç§’</option>';
                for (let i = 0; i < 60; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${i.toString().padStart(2, '0')}ç§’`;
                    secondSelect.appendChild(option);
                }
            }
        }


        // åˆå§‹åŒ–è‡ªåŠ¨æ‰“å¼€æ–‡ä»¶é€‰æ‹©
        function initAutoOpenSelection() {
            const container = document.getElementById('readingAutoOpenFiles');
            if (!container) {
                console.error('æ‰¾ä¸åˆ° readingAutoOpenFiles å®¹å™¨');
                return;
            }

            container.innerHTML = '';

            let hasItems = false;

            // æ·»åŠ æ–‡ä»¶é€‰æ‹© - ç¡®ä¿ currentFiles.reading å­˜åœ¨
            if (currentFiles.reading && currentFiles.reading.length > 0) {
                console.log('æ‰¾åˆ°æ–‡ä»¶:', currentFiles.reading);
                const fileSection = document.createElement('div');
                fileSection.innerHTML = '<div style="font-weight: 600; margin: 10px 0 5px 0; color: #333;">ğŸ“ æ–‡ä»¶</div>';
                container.appendChild(fileSection);

                currentFiles.reading.forEach((file, index) => {
                    const checkbox = document.createElement('div');
                    checkbox.className = 'time-item-checkbox';
                    checkbox.innerHTML = `
                <input type="checkbox" id="autoOpenFile${index}" 
                       onchange="toggleAutoOpenFile(${index}, this.checked)">
                <div class="item-content-preview" title="${file.name}">${file.name}</div>
            `;
                    container.appendChild(checkbox);
                    hasItems = true;
                });
            } else {
                console.log('æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶', currentFiles);
            }

            // æ·»åŠ å›¾ç‰‡é€‰æ‹© - ç¡®ä¿ currentImages.reading å­˜åœ¨
            if (currentImages.reading && currentImages.reading.length > 0) {
                console.log('æ‰¾åˆ°å›¾ç‰‡:', currentImages.reading);
                const imageSection = document.createElement('div');
                imageSection.innerHTML = '<div style="font-weight: 600; margin: 10px 0 5px 0; color: #333;">ğŸ“· å›¾ç‰‡</div>';
                container.appendChild(imageSection);

                currentImages.reading.forEach((image, index) => {
                    const checkbox = document.createElement('div');
                    checkbox.className = 'time-item-checkbox';
                    checkbox.innerHTML = `
                <input type="checkbox" id="autoOpenImage${index}" 
                       onchange="toggleAutoOpenImage(${index}, this.checked)">
                <div class="item-content-preview" title="${image.name}">${image.name}</div>
            `;
                    container.appendChild(checkbox);
                    hasItems = true;
                });
            } else {
                console.log('æ²¡æœ‰æ‰¾åˆ°å›¾ç‰‡', currentImages);
            }

            // å¦‚æœæ²¡æœ‰æ–‡ä»¶æˆ–å›¾ç‰‡
            if (!hasItems) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">è¯·å…ˆä¸Šä¼ æ–‡ä»¶æˆ–å›¾ç‰‡</div>';
            }
        }


        // åˆ‡æ¢è‡ªåŠ¨æ‰“å¼€æ–‡ä»¶
        function toggleAutoOpenFile(index, checked) {
            if (checked) {
                readingTimeSettings.autoOpenFiles.push(currentFiles.reading[index]);
            } else {
                readingTimeSettings.autoOpenFiles = readingTimeSettings.autoOpenFiles.filter(
                    (_, i) => i !== index
                );
            }
        }

        // åˆ‡æ¢è‡ªåŠ¨æ‰“å¼€å›¾ç‰‡
        function toggleAutoOpenImage(index, checked) {
            if (checked) {
                readingTimeSettings.autoOpenImages.push(currentImages.reading[index]);
            } else {
                readingTimeSettings.autoOpenImages = readingTimeSettings.autoOpenImages.filter(
                    (_, i) => i !== index
                );
            }
        }

        function applyReadingTimeSettings() {
            // å¤„ç†è‡ªå®šä¹‰æ—¶é—´
            if (readingTimeSettings.type === 'custom') {
                const hour = document.getElementById('readingCustomHour').value;
                const minute = document.getElementById('readingCustomMinute').value;
                const second = document.getElementById('readingCustomSecond').value;

                if (!hour || !minute || !second) {
                    showToast('è¯·é€‰æ‹©å®Œæ•´çš„æ—¶é—´', 'error');
                    return;
                }

                readingTimeSettings.startTime = new Date();
                readingTimeSettings.startTime.setHours(parseInt(hour), parseInt(minute), parseInt(second), 0);

                // å¦‚æœé€‰æ‹©çš„æ—¶é—´å·²ç»è¿‡å»ï¼Œå°±è®¾ç½®ä¸ºæ˜å¤©
                if (readingTimeSettings.startTime <= new Date()) {
                    readingTimeSettings.startTime.setDate(readingTimeSettings.startTime.getDate() + 1);
                }
            }

            if (!readingTimeSettings.startTime) {
                selectReadingType('morning'); // é»˜è®¤é€‰æ‹©æ—©è¯»
            }

            showToast(`å·²è®¾ç½®${getReadingTypeText(readingTimeSettings.type)}æ—¶é—´`, 'success');

            // å…³é—­æ—¶é—´è®¾ç½®é¢æ¿
            document.getElementById('readingTimeInfo').style.display = 'none';
        }
        //è·å–æ—©æ™šè¯»ç±»å‹æ–‡æœ¬
        function getReadingTypeText(type) {
            switch (type) {
                case 'morning': return 'æ—©è¯»';
                case 'evening': return 'æ™šè¯»';
                case 'custom': return 'è‡ªå®šä¹‰';
                default: return 'æ—©æ™šè¯»';
            }
        }
        // æ˜¾ç¤ºæ—©æ™šè¯»æ—¶é—´è®¾ç½®
        function showReadingTimeSettings() {
            const timeInfo = document.getElementById('readingTimeInfo');
            if (timeInfo) {
                if (timeInfo.style.display === 'none' || !timeInfo.style.display) {
                    timeInfo.style.display = 'block';
                    // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿æ–‡ä»¶å·²ç»åŠ è½½
                    setTimeout(() => {
                        initAutoOpenSelection();
                    }, 100);
                    // é»˜è®¤é€‰æ‹©æ—©è¯»
                    if (!readingTimeSettings.type) {
                        selectReadingType('morning');
                    }
                } else {
                    timeInfo.style.display = 'none';
                }
            }
        }

        async function publishReading() {
            const title = document.getElementById('readingTitle').value;
            const items = Array.from(document.querySelectorAll('#readingItems .item-row')).map(row => {
                const content = row.querySelector('.item-input').value;
                const time = row.querySelector('.time-input').value;
                return { content, time };
            }).filter(item => item.content.trim() !== '');

            if (!title || items.length === 0) {
                showToast('è¯·å¡«å†™æ ‡é¢˜å’Œè‡³å°‘ä¸€æ¡é˜…è¯»å†…å®¹', 'error');
                return;
            }

            // åªåœ¨æœ‰æ–‡ä»¶ä¸Šä¼ æ—¶æ‰æ£€æŸ¥ä¸Šä¼ çŠ¶æ€
            if (currentFiles.reading.length > 0 && uploadStatus.reading.uploading) {
                showToast('æ–‡ä»¶æ­£åœ¨ä¸Šä¼ ä¸­ï¼Œè¯·ç¨åå‘å¸ƒ', 'error');
                return;
            }

            try {
                let totalMinutes = 0;
                items.forEach(item => {
                    if (item.time) {
                        const minutes = parseInt(item.time) || 0;
                        totalMinutes += minutes;
                    }
                });

                const endTime = readingTimeSettings.startTime ?
                    new Date(readingTimeSettings.startTime.getTime() + totalMinutes * 60 * 1000) : null;

                let content = items.map((item, index) => {
                    if (item.time) {
                        return `${index + 1}. ${item.content}ï¼ˆ${item.time}ï¼‰`;
                    } else {
                        return `${index + 1}. ${item.content}`;
                    }
                }).join('\n');

                const Notice = AV.Object.extend('Notice');
                const notice = new Notice();
                notice.set('title', `ã€æ—©æ™šè¯»ã€‘${title}`);
                notice.set('content', content);
                notice.set('author', currentUser.get('username'));
                notice.set('type', 'reading');

                // ä¿å­˜æ—¶é—´è®¾ç½®ä¿¡æ¯
                if (readingTimeSettings.startTime) {
                    notice.set('readingType', readingTimeSettings.type);
                    notice.set('readingStartTime', readingTimeSettings.startTime.toISOString());
                    notice.set('readingDuration', totalMinutes);
                    if (endTime) {
                        notice.set('readingEndTime', endTime.toISOString());
                    }
                }

                // ä¿å­˜è‡ªåŠ¨æ‰“å¼€æ–‡ä»¶ä¿¡æ¯
                if (readingTimeSettings.autoOpenFiles.length > 0) {
                    notice.set('autoOpenFiles', readingTimeSettings.autoOpenFiles.map(f => f.name));
                    notice.set('autoOpenFileUrls', readingTimeSettings.autoOpenFiles.map(f => f.githubUrl));
                    notice.set('autoOpenFileUniqueNames', readingTimeSettings.autoOpenFiles.map(f => f.uniqueName));
                }
                if (readingTimeSettings.autoOpenImages.length > 0) {
                    notice.set('autoOpenImages', readingTimeSettings.autoOpenImages.map(img => img.name));
                    notice.set('autoOpenImageUrls', readingTimeSettings.autoOpenImages.map(img => img.githubUrl));
                    notice.set('autoOpenImageUniqueNames', readingTimeSettings.autoOpenImages.map(img => img.uniqueName));
                }

                // ä¿å­˜æ–‡ä»¶ä¿¡æ¯
                if (currentFiles.reading.length > 0) {
                    notice.set('fileCount', currentFiles.reading.length);
                    notice.set('fileNames', currentFiles.reading.map(f => f.name));
                    notice.set('fileUrls', currentFiles.reading.map(f => f.githubUrl));
                    notice.set('fileUniqueNames', currentFiles.reading.map(f => f.uniqueName));
                }

                // ä¿å­˜å›¾ç‰‡ä¿¡æ¯
                if (currentImages.reading.length > 0) {
                    notice.set('images', currentImages.reading.map(img => img.githubUrl));
                    notice.set('imageCount', currentImages.reading.length);
                    notice.set('imageNames', currentImages.reading.map(img => img.name));
                    notice.set('imageUniqueNames', currentImages.reading.map(img => img.uniqueName));
                }

                // åªåœ¨æœ‰æ–‡ä»¶ä¸Šä¼ æ—¶æ‰ç¦ç”¨æŒ‰é’®
                if (currentFiles.reading.length > 0 || currentImages.reading.length > 0) {
                    updateUploadStatus('reading', { uploading: true });
                }

                await notice.save();
                showToast('æ—©æ™šè¯»å‘å¸ƒæˆåŠŸï¼', 'success');
                closeModal('readingModal');

                // é‡ç½®æ—¶é—´è®¾ç½®
                readingTimeSettings = {
                    type: 'morning',
                    startTime: null,
                    autoOpenFiles: [],
                    autoOpenImages: []
                };

            } catch (error) {
                console.error('å‘å¸ƒå¤±è´¥:', error);
                showToast('å‘å¸ƒå¤±è´¥ï¼š' + error.message, 'error');
            } finally {
                // é‡æ–°å¯ç”¨å‘å¸ƒæŒ‰é’®
                updateUploadStatus('reading', { uploading: false });
            }

        }
        document.addEventListener('DOMContentLoaded', function () {
            checkLoginStatus();
            resetDailyUploadStats();
            setupTimeInputEvents();

            // åˆå§‹åŒ–ä¸Šä¼ çŠ¶æ€
            updateUploadStatus('homework', { uploading: false, success: false, error: false });
            updateUploadStatus('reading', { uploading: false, success: false, error: false });
        });
        // æ›¿æ¢åŸæ¥çš„ uploadStatus å£°æ˜
        let uploadStatus = {
            homework: { uploading: false, success: false, error: false },
            reading: { uploading: false, success: false, error: false }
        };
        // æ›´æ–°ä¸Šä¼ çŠ¶æ€
        function updateUploadStatus(type, status) {
            if (uploadStatus[type]) {
                uploadStatus[type] = { ...uploadStatus[type], ...status };
            }
            updatePublishButtonState(type);
        }

        function updatePublishButtonState(type) {
            const publishButton = document.querySelector(`#${type}Modal .btn:not(.btn-secondary)`);
            if (publishButton) {
                if (uploadStatus[type].uploading) {
                    publishButton.disabled = true;
                    publishButton.style.opacity = '0.6';
                    publishButton.style.cursor = 'not-allowed';
                    publishButton.textContent = type === 'homework' ? 'ä¸Šä¼ ä¸­...' : 'ä¸Šä¼ ä¸­...';
                } else {
                    publishButton.disabled = false;
                    publishButton.style.opacity = '1';
                    publishButton.style.cursor = 'pointer';
                    publishButton.textContent = type === 'homework' ? 'è®¾ç½®ä½œä¸šæ—¶é—´' : 'è®¾ç½®æ—©æ™šè¯»æ—¶é—´';
                }
            }
        }

    </script>
</body>
</html>