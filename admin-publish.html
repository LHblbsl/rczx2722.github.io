<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理员发布 - 班级管理系统</title>
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.13.2/dist/av-min.js"></script>
    <style>
        /* 时间设置相关样式 */
        /* 美化时间设置界面 */
        .time-mode-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .time-mode-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-weight: 500;
        }

            .time-mode-btn.active {
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                border-color: #667eea;
                transform: scale(1.02);
            }

        .time-settings-section {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 1px solid #e1e5e9;
        }

        .time-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .time-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

            .time-input:focus {
                border-color: #667eea;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            }

        .datetime-inputs {
            display: flex;
            gap: 8px;
            align-items: center;
        }

            .datetime-inputs select {
                flex: 1;
                padding: 12px;
                border: 2px solid #e1e5e9;
                border-radius: 8px;
                background: white;
                cursor: pointer;
            }

        .time-hint {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        /* 条目选择样式 */
        .item-selection-section {
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .time-item-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            margin: 5px 0;
            background: white;
            border-radius: 8px;
            border: 1px solid #e1e5e9;
            transition: all 0.3s ease;
        }

            .time-item-checkbox:hover {
                background: #f8f9fa;
                border-color: #667eea;
            }

            .time-item-checkbox input[type="checkbox"] {
                width: 18px;
                height: 18px;
                border-radius: 4px;
                border: 2px solid #ddd;
                cursor: pointer;
            }

                .time-item-checkbox input[type="checkbox"]:checked {
                    background: #667eea;
                    border-color: #667eea;
                }

        .item-number {
            font-weight: 600;
            color: #667eea;
            min-width: 20px;
        }

        .item-content-preview {
            flex: 1;
            font-size: 14px;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
       
        .time-settings-section {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .datetime-inputs {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .item-selection-section {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .time-item-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 8px 0;
            padding: 8px;
            background: white;
            border-radius: 6px;
        }

        .deadline-info {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            font-size: 14px;
        }

        .countdown-timer {
            color: #e74c3c;
            font-weight: bold;
            margin-left: 5px;
        }
        /* 进度条样式 */
        .upload-progress {
            width: 100%;
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            margin: 10px 0;
            overflow: hidden;
            display: none;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #00b894, #00a085);
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            font-size: 12px;
            color: #666;
            text-align: center;
            margin-top: 5px;
        }

        .uploading .file-upload-area {
            opacity: 0.6;
            pointer-events: none;
        }
        /* 图片上传相关样式 */
        .header-actions {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .header-action-btn {
            padding: 15px 20px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 140px;
            justify-content: center;
        }

            .header-action-btn.file-btn {
                background: linear-gradient(135deg, #00b894, #00a085);
                box-shadow: 0 4px 15px rgba(0, 184, 148, 0.3);
            }

            .header-action-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            }

            .header-action-btn:active {
                transform: translateY(0);
            }
        .image-preview-area {
            margin-bottom: 20px;
            max-height: 200px;
            overflow-y: auto;
        }

        .image-preview-item {
            position: relative;
            display: inline-block;
            margin: 5px;
            border-radius: 8px;
            overflow: hidden;
        }

        .image-preview {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
        }

        .remove-image-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(231, 76, 60, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
        }

        .file-info-area {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #e1e5e9;
        }

        .file-upload-area {
            border: 2px dashed #00b894;
            border-radius: 12px;
            padding: 30px 20px;
            text-align: center;
            background: rgba(0, 184, 148, 0.05);
            margin-bottom: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

            .file-upload-area.drag-over {
                background: rgba(0, 184, 148, 0.1);
                border-color: #00a085;
                transform: scale(1.02);
            }

        .file-upload-icon {
            font-size: 48px;
            margin-bottom: 10px;
            color: #00b894;
        }

        .file-upload-text {
            font-size: 16px;
            color: #555;
            margin-bottom: 8px;
        }

        .file-upload-hint {
            font-size: 12px;
            color: #888;
        }

        /* 文件列表样式 */
        .file-list {
            margin-top: 15px;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid #00b894;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .file-icon {
            font-size: 20px;
            color: #00b894;
        }

        .file-details {
            flex: 1;
        }

        .file-name {
            font-weight: 500;
            color: #333;
            margin-bottom: 2px;
        }

        .file-size {
            font-size: 12px;
            color: #666;
        }

        .file-remove {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 12px;
        }

        /* 上传统计信息 */
        .upload-stats {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .stats-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .stats-limit {
            color: #e74c3c;
            font-weight: 600;
        }

        .file-summary {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #666;
        }

        .file-count-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .count-btn {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 6px;
            background: #3498db;
            color: white;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .count-display {
            font-weight: 600;
            color: #333;
            min-width: 30px;
            text-align: center;
        }

        .file-hint {
            font-size: 12px;
            color: #e74c3c;
            margin-top: 5px;
        }

        /* 调整模态框位置 */
        .modal-content {
            background: white;
            border-radius: 20px 20px 0 0;
            padding: 30px 20px 20px;
            width: 100%;
            position: absolute;
            bottom: 5%;
            left: 0;
            transform: translateY(100%);
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            max-height: 90vh;
            overflow-y: auto;
        }
        .time-input {
            width: 120px;
            padding: 12px;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

            .time-input:focus {
                border-color: #00b894;
                box-shadow: 0 0 0 2px rgba(0, 184, 148, 0.1);
            }

        .time-hint {
            font-size: 12px;
            color: #00b894;
            margin-top: 4px;
            animation: fadeIn 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f6fa;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* 主容器 */
        .app-container {
            max-width: 100%;
            min-height: 100vh;
            background: white;
            border-radius: 0;
            position: relative;
            overflow: hidden;
        }

        /* 顶部状态栏 */
        .status-bar {
            height: 44px;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            color: #666;
            font-size: 14px;
        }

        /* 头部导航 */
        .header {
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .app-title {
            font-size: 20px;
            font-weight: 700;
            color: #333;
        }

        .back-btn {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

            .back-btn:active {
                transform: scale(0.95);
            }

        /* 功能板块容器 */
        .sections-container {
            padding: 20px;
            display: grid;
            gap: 20px;
        }

        /* 功能板块通用样式 */
        .section {
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

            .section:active {
                transform: scale(0.98);
            }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: white;
        }

        .section-icon {
            font-size: 24px;
        }

        /* 不同板块的颜色 */
        .section-homework {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: #667eea;
        }

        .section-reading {
            background: linear-gradient(135deg, #00b894, #00a085);
            border-color: #00b894;
        }

        .section-call {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            border-color: #f39c12;
        }

        .section-important {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            border-color: #e74c3c;
        }

        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: white;
            border-radius: 20px 20px 0 0;
            padding: 30px 20px 20px;
            width: 100%;
            position: absolute;
            bottom: 0;
            left: 0;
            transform: translateY(100%);
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 20px;
            text-align: center;
            position: relative;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: #333;
        }

        .close-btn {
            position: absolute;
            right: 0;
            top: 0;
            background: none;
            border: none;
            font-size: 20px;
            color: #666;
            cursor: pointer;
        }

        /* 表单样式 */
        .form-group {
            margin-bottom: 20px;
        }

            .form-group label {
                display: block;
                margin-bottom: 8px;
                color: #555;
                font-weight: 500;
                font-size: 14px;
            }

        .form-control {
            width: 100%;
            padding: 16px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #fafafa;
        }

            .form-control:focus {
                outline: none;
                border-color: #667eea;
                background: white;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            }

        textarea.form-control {
            height: 120px;
            resize: vertical;
        }

        /* 条目列表 */
        .items-list {
            margin-bottom: 20px;
        }

        .item-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .item-number {
            font-weight: 600;
            color: #666;
            min-width: 30px;
        }

        .item-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
        }

        .time-input {
            width: 120px;
            padding: 12px;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
        }

        .remove-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .add-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 15px;
        }

        /* 按钮样式 */
        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            width: 100%;
            margin-top: 10px;
        }

            .btn:active {
                transform: scale(0.95);
                box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
            }

        .btn-homework {
            background: linear-gradient(135deg, #667eea, #764ba2);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-reading {
            background: linear-gradient(135deg, #00b894, #00a085);
            box-shadow: 0 4px 15px rgba(0, 184, 148, 0.3);
        }

        .btn-important {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            box-shadow: 0 4px 15px rgba(149, 165, 166, 0.3);
        }

        /* 模板管理 */
        .template-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #f0f0f0;
        }

        .template-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .template-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }

        .save-template {
            background: #27ae60;
            color: white;
        }

        .load-template {
            background: #3498db;
            color: white;
        }

        /* 动画效果 */
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .file-upload-area, .file-list, .upload-stats {
            animation: slideDown 0.3s ease;
        }

        /* 消息提示 */
        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
        }

            .toast.show {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- 顶部状态栏 -->
        <div class="status-bar">
            <div id="currentTime"></div>
            <div id="networkStatus">在线</div>
        </div>

        <!-- 头部 -->
        <div class="header">
            <div class="header-content">
                <button class="back-btn" onclick="goBack()">← 返回</button>
                <div class="app-title">管理员发布</div>
                <div style="width: 60px;"></div>
            </div>
        </div>

        <!-- 功能板块 -->
        <!-- 功能板块 -->
        <div class="sections-container">
            <!-- 发布作业 -->
            <div class="section section-homework" onclick="openHomeworkModal()">
                <div class="section-header">
                    <div class="section-title">发布作业</div>
                    <div class="section-icon">📚</div>
                </div>
                <div style="color: rgba(255,255,255,0.8); font-size: 14px;">
                    布置每日作业和练习
                </div>
            </div>

            <!-- 发布早晚读 -->
            <div class="section section-reading" onclick="openReadingModal()">
                <div class="section-header">
                    <div class="section-title">发布早晚读</div>
                    <div class="section-icon">📖</div>
                </div>
                <div style="color: rgba(255,255,255,0.8); font-size: 14px;">
                    安排晨读和晚读内容
                </div>
            </div>

            <!-- 召唤同学 -->
            <div class="section section-call" onclick="goToStudentSummon()">
                <div class="section-header">
                    <div class="section-title">召唤同学</div>
                    <div class="section-icon">📢</div>
                </div>
                <div style="color: rgba(255,255,255,0.8); font-size: 14px;">
                    快速召唤学生，提高课堂效率
                </div>
            </div>

            <!-- 发布重要消息 -->
            <div class="section section-important" onclick="openImportantModal()">
                <div class="section-header">
                    <div class="section-title">发布重要消息</div>
                    <div class="section-icon">⚠️</div>
                </div>
                <div style="color: rgba(255,255,255,0.8); font-size: 14px;">
                    紧急通知和重要公告
                </div>
            </div>
        </div>
    </div>

    <!-- 发布作业模态框 -->
    <div id="homeworkModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">发布作业</h3>
                <div class="header-actions">
                    <button class="header-action-btn" onclick="triggerImageUpload('homework')">
                        📷 添加图片
                    </button>
                    <button class="header-action-btn" onclick="showFileSettings('homework')">
                        📎 文件设置
                    </button>
                    <!-- 添加时间设置按钮 -->
                    <button class="header-action-btn" onclick="showTimeSettings('homework')">
                        ⏰ 时间设置
                    </button>
                </div>
                <button class="close-btn" onclick="closeModal('homeworkModal')">×</button>
            </div>

            <!-- 图片预览区域 -->
            <div id="homeworkImagePreview" class="image-preview-area" style="display: none;">
                <!-- 动态生成的图片预览 -->
            </div>

            <!-- 文件信息区域 -->
            <div id="homeworkFileInfo" class="file-info-area" style="display: none;">
                <!-- 上传统计 -->
                <div class="upload-stats">
                    <div class="stats-item">
                        <span>今日已上传:</span>
                        <span id="homeworkTodayUsage">0MB / 30MB</span>
                    </div>
                    <div class="stats-item">
                        <span>剩余额度:</span>
                        <span class="stats-limit" id="homeworkRemaining">30MB</span>
                    </div>
                </div>

                <!-- 文件上传区域 -->
                <div class="file-upload-area" id="homeworkFileUpload"
                     ondragover="handleDragOver(event)"
                     ondragleave="handleDragLeave(event)"
                     ondrop="handleFileDrop('homework', event)"
                     onclick="triggerFileUpload('homework')">
                    <div class="file-upload-icon">📎</div>
                    <div class="file-upload-text">点击或拖拽文件到此区域</div>
                    <div class="file-upload-hint">单个文件不超过10MB，今日总上限30MB</div>
                </div>

                <!-- 文件列表 -->
                <div class="file-list" id="homeworkFileList">
                    <!-- 动态生成的文件列表 -->
                </div>

                <div class="file-hint">
                    ⚠️ 文件将在3天后自动删除，重要文件请使用QQ发送
                </div>
            </div>
            <!-- 在文件信息区域后面添加时间设置区域 -->
            <!-- 替换原来的时间设置区域 -->
            <div id="homeworkTimeInfo" class="file-info-area" style="display: none;">
                <div class="upload-stats">
                    <div class="stats-item">
                        <span>时间设置模式:</span>
                    </div>
                </div>

                <!-- 美化后的时间模式选择 -->
                <div class="time-mode-selector">
                    <div class="time-mode-btn active" data-mode="countdown" onclick="selectTimeMode('homework', 'countdown')">
                        ⏱️ 倒数模式
                        <div class="time-hint">设置剩余小时数</div>
                    </div>
                    <div class="time-mode-btn" data-mode="datetime" onclick="selectTimeMode('homework', 'datetime')">
                        📅 日期模式
                        <div class="time-hint">选择具体日期时间</div>
                    </div>
                </div>

                <!-- 倒数模式设置 -->
                <div id="homeworkCountdownSettings" class="time-settings-section">
                    <div class="form-group">
                        <label>剩余时间设置</label>
                        <div class="time-input-group">
                            <input type="number" id="homeworkCountdownHours" class="time-input"
                                   placeholder="输入小时数（可小数）" step="0.1" min="0.1">
                            <span style="white-space: nowrap;">小时</span>
                        </div>
                        <div class="time-hint">例如：1.5小时 = 90分钟，0.5小时 = 30分钟</div>
                    </div>
                </div>

                <!-- 日期模式设置 -->
                <div id="homeworkDatetimeSettings" class="time-settings-section" style="display: none;">
                    <div class="form-group">
                        <label>截止日期和时间</label>
                        <div class="datetime-inputs">
                            <select id="homeworkDeadlineMonth" class="time-input">
                                <option value="">选择月份</option>
                                <!-- 月份选项将通过JS生成 -->
                            </select>
                            <select id="homeworkDeadlineDay" class="time-input">
                                <option value="">选择日期</option>
                                <!-- 日期选项将通过JS生成 -->
                            </select>
                            <select id="homeworkDeadlineHour" class="time-input">
                                <option value="">选择小时</option>
                                <!-- 小时选项将通过JS生成 -->
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 精简的条目选择区域 -->
                <div class="item-selection-section">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600;">选择应用时间的作业条目:</label>
                    <div id="homeworkTimeItems">
                        <!-- 动态生成的条目选择 -->
                    </div>
                </div>

                <!-- 在作业模态框的时间设置区域 -->
                <button class="btn" onclick="applyTimeSettings('homework')"
                        style="margin-top: 15px; background: linear-gradient(135deg, #3498db, #2980b9); width: 100%;">
                    ✅ 应用时间设置
                </button>
            </div>

            <!-- 隐藏的文件输入 -->
            <input type="file" id="homeworkFileInput" multiple style="display: none;"
                   onchange="handleFileUpload('homework', this.files)">

            <div class="form-group">
                <input type="text" id="homeworkTitle" class="form-control" placeholder="作业标题/科目">
            </div>

            <div class="form-group">
                <label>作业内容（每行一条）</label>
                <div class="items-list" id="homeworkItems">
                    <!-- 动态生成的条目 -->
                </div>
                <button class="add-btn" onclick="addHomeworkItem()">+ 添加条目</button>
            </div>

            <div class="template-section">
                <label>模板管理</label>
                <div class="template-buttons">
                    <button class="template-btn save-template" onclick="saveHomeworkTemplate()">保存模板</button>
                    <button class="template-btn load-template" onclick="loadHomeworkTemplate()">加载模板</button>
                </div>
            </div>

            <button class="btn btn-homework" onclick="publishHomework()">发布作业</button>
            <button class="btn btn-secondary" onclick="closeModal('homeworkModal')">取消</button>

            <!-- 隐藏的文件输入 -->
            <input type="file" id="homeworkImageInput" accept="image/*" multiple style="display: none;"
                   onchange="handleImageUpload('homework', this.files)">
        </div>
    </div>

    <!-- 发布早晚读模态框 -->
    <div id="readingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">发布早晚读</h3>
                <div class="header-actions">
                    <button class="header-action-btn" onclick="triggerImageUpload('reading')">
                        📷 添加图片
                    </button>
                    <button class="header-action-btn" onclick="showFileSettings('reading')">
                        📎 文件设置
                    </button>
                    <!-- 添加时间设置按钮 -->
                    <button class="header-action-btn" onclick="showTimeSettings('reading')">
                        ⏰ 时间设置
                    </button>
                </div>
                <button class="close-btn" onclick="closeModal('readingModal')">×</button>
            </div>

            <!-- 图片预览区域 -->
            <div id="readingImagePreview" class="image-preview-area" style="display: none;">
                <!-- 动态生成的图片预览 -->
            </div>

            <!-- 文件信息区域 -->
            <div id="readingFileInfo" class="file-info-area" style="display: none;">
                <!-- 上传统计 -->
                <div class="upload-stats">
                    <div class="stats-item">
                        <span>今日已上传:</span>
                        <span id="readingTodayUsage">0MB / 30MB</span>
                    </div>
                    <div class="stats-item">
                        <span>剩余额度:</span>
                        <span class="stats-limit" id="readingRemaining">30MB</span>
                    </div>
                </div>

                <!-- 文件上传区域 -->
                <div class="file-upload-area" id="readingFileUpload"
                     ondragover="handleDragOver(event)"
                     ondragleave="handleDragLeave(event)"
                     ondrop="handleFileDrop('reading', event)"
                     onclick="triggerFileUpload('reading')">
                    <div class="file-upload-icon">📎</div>
                    <div class="file-upload-text">点击或拖拽文件到此区域</div>
                    <div class="file-upload-hint">单个文件不超过10MB，今日总上限30MB</div>
                </div>

                <!-- 文件列表 -->
                <div class="file-list" id="readingFileList">
                    <!-- 动态生成的文件列表 -->
                </div>

                <div class="file-hint">
                    ⚠️ 文件将在3天后自动删除，重要文件请使用QQ发送
                </div>
            </div>
            <!-- 替换原来的早晚读时间设置区域 -->
            <div id="readingTimeInfo" class="file-info-area" style="display: none;">
                <div class="upload-stats">
                    <div class="stats-item">
                        <span>早晚读时间设置:</span>
                    </div>
                </div>

                <!-- 早晚读类型选择 -->
                <div class="form-group">
                    <label>早晚读类型</label>
                    <div class="time-mode-selector">
                        <div class="time-mode-btn active" data-mode="morning" onclick="selectReadingType('morning')">
                            🌅 早读
                            <div class="time-hint">7:20 开始</div>
                        </div>
                        <div class="time-mode-btn" data-mode="evening" onclick="selectReadingType('evening')">
                            🌙 晚读
                            <div class="time-hint">18:00 开始</div>
                        </div>
                        <div class="time-mode-btn" data-mode="custom" onclick="selectReadingType('custom')">
                            ⚙️ 自定义
                            <div class="time-hint">自定义开始时间</div>
                        </div>
                    </div>
                </div>

                <!-- 自定义时间设置 -->
                <div id="readingCustomTime" class="time-settings-section" style="display: none;">
                    <div class="form-group">
                        <label>自定义开始时间（24小时制）</label>
                        <div class="datetime-inputs">
                            <select id="readingCustomHour" class="time-input">
                                <option value="">时</option>
                                <!-- 小时选项将通过JS生成 -->
                            </select>
                            <select id="readingCustomMinute" class="time-input">
                                <option value="">分</option>
                                <!-- 分钟选项将通过JS生成 -->
                            </select>
                            <select id="readingCustomSecond" class="time-input">
                                <option value="">秒</option>
                                <!-- 秒钟选项将通过JS生成 -->
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 自动打开文件设置 -->
                <div class="form-group">
                    <label>到时间自动打开文件/图片</label>
                    <div id="readingAutoOpenFiles" class="item-selection-section">
                        <!-- 动态生成的文件和图片选择 -->
                    </div>
                    <div class="time-hint">勾选的文件和图片将在开始时间自动打开（客户端功能）</div>
                </div>

                <button class="btn" onclick="applyReadingTimeSettings()" style="margin-top: 15px;">
                    ✅ 应用时间设置
                </button>
            </div>
            <!-- 隐藏的文件输入 -->
            <input type="file" id="readingFileInput" multiple style="display: none;"
                   onchange="handleFileUpload('reading', this.files)">

            <div class="form-group">
                <input type="text" id="readingTitle" class="form-control" placeholder="早晚读标题/科目">
            </div>

            <div class="form-group">
                <label>内容安排</label>
                <div class="items-list" id="readingItems">
                    <!-- 动态生成的条目 -->
                </div>
                <button class="add-btn" onclick="addReadingItem()">+ 添加条目</button>
            </div>

            <div class="template-section">
                <label>模板管理</label>
                <div class="template-buttons">
                    <button class="template-btn save-template" onclick="saveReadingTemplate()">保存模板</button>
                    <button class="template-btn load-template" onclick="loadReadingTemplate()">加载模板</button>
                </div>
            </div>

            <button class="btn btn-reading" onclick="publishReading()">发布早晚读</button>
            <button class="btn btn-secondary" onclick="closeModal('readingModal')">取消</button>

            <!-- 隐藏的文件输入 -->
            <input type="file" id="readingImageInput" accept="image/*" multiple style="display: none;"
                   onchange="handleImageUpload('reading', this.files)">
        </div>
    </div>

    <!-- 发布重要消息模态框 -->
    <div id="importantModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">发布重要消息</h3>
                <button class="close-btn" onclick="closeModal('importantModal')">×</button>
            </div>

            <div class="form-group">
                <input type="text" id="importantTitle" class="form-control" placeholder="消息标题">
            </div>

            <div class="form-group">
                <label>消息内容（每行一条）</label>
                <div class="items-list" id="importantItems">
                    <!-- 动态生成的条目 -->
                </div>
                <button class="add-btn" onclick="addImportantItem()">+ 添加条目</button>
            </div>

            <div class="template-section">
                <label>模板管理</label>
                <div class="template-buttons">
                    <button class="template-btn save-template" onclick="saveImportantTemplate()">保存模板</button>
                    <button class="template-btn load-template" onclick="loadImportantTemplate()">加载模板</button>
                </div>
            </div>

            <button class="btn btn-important" onclick="publishImportant()">发布重要消息</button>
            <button class="btn btn-secondary" onclick="closeModal('importantModal')">取消</button>
        </div>
    </div>

    <!-- 消息提示 -->
    <div id="toast" class="toast"></div>

    <script>
        // 初始化 LeanCloud
        const APP_ID = 'qUmcbO6SrqiCqp9iyY4xXFIQ-gzGzoHsz';
        const APP_KEY = 't3XBdjkUPITzsMYwAo3KC15s';
        const SERVER_URL = 'https://qumcbo6s.lc-cn-n1-shared.com';

        AV.init({
            appId: APP_ID,
            appKey: APP_KEY,
            serverURLs: SERVER_URL
        });

        let currentUser = null;
        let currentModalType = '';

        // 检查登录状态和权限
        async function checkLoginStatus() {
            const user = AV.User.current();
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            try {
                const userQuery = new AV.Query('_User');
                currentUser = await userQuery.get(user.id);
                const isAdmin = currentUser.get('isAdmin') || false;
                const isSuperAdmin = currentUser.get('username') === 'Lan';

                if (!isAdmin && !isSuperAdmin) {
                    showToast('无权限访问此页面', 'error');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                    return;
                }

                updateTime();
                setInterval(updateTime, 1000);

            } catch (error) {
                console.error('初始化失败:', error);
                showToast('初始化失败，请刷新页面');
            }
        }

        // 返回主页
        function goBack() {
            window.location.href = 'index.html';
        }

        // 更新时间
        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent =
                `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
        }

        // 显示消息提示
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // 关闭模态框
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // 打开作业模态框
     

        // 初始化作业条目
        function initHomeworkItems() {
            const container = document.getElementById('homeworkItems');
            container.innerHTML = '';
            addHomeworkItem(); // 默认添加一个空条目
        }

        // 添加作业条目
        function addHomeworkItem() {
            const container = document.getElementById('homeworkItems');
            const itemCount = container.children.length + 1;

            const itemRow = document.createElement('div');
            itemRow.className = 'item-row';
            itemRow.innerHTML = `
                            <div class="item-number">${itemCount}.</div>
                            <input type="text" class="item-input" placeholder="作业内容 ${itemCount}">
                            <button class="remove-btn" onclick="removeItem(this)">删除</button>
                        `;
            container.appendChild(itemRow);
        }

   

        // 初始化早晚读条目
        function initReadingItems() {
            const container = document.getElementById('readingItems');
            container.innerHTML = '';
            addReadingItem(); // 默认添加一个空条目
        }

        // 添加早晚读条目
        function addReadingItem() {
            const container = document.getElementById('readingItems');
            const itemCount = container.children.length + 1;

            const itemRow = document.createElement('div');
            itemRow.className = 'item-row';
            itemRow.innerHTML = `
                <div class="item-number">${itemCount}.</div>
                <input type="text" class="item-input" placeholder="阅读内容 ${itemCount}">
                <input type="text" class="time-input" placeholder="进行时间（分钟）" onblur="formatTimeInput(this)">
                <button class="remove-btn" onclick="removeItem(this)">删除</button>
            `;
            container.appendChild(itemRow);
        }

        // 格式化时间输入
        // 增强的时间输入处理
        function formatTimeInput(input) {
            let value = input.value.trim();

            if (!value) return;

            // 处理各种输入格式
            if (/^\d+$/.test(value)) {
                // 纯数字：20 → 20分钟
                input.value = value + '分钟';
            } else if (/^\d+[分]?$/.test(value)) {
                // 数字+分：20分 → 20分钟
                value = value.replace('分', '');
                input.value = value + '分钟';
            } else if (/^\d+min$/.test(value.toLowerCase())) {
                // 数字+min：20min → 20分钟
                value = value.replace(/min/gi, '');
                input.value = value + '分钟';
            } else if (/^\d+分钟$/.test(value)) {
                // 已经是正确格式，不做处理
                return;
            } else {
                // 其他格式，提示用户
                showToast('请输入数字或"数字+分钟"，如：20 或 30分钟', 'error');
                input.focus();
            }
        }

        // 在输入时实时提示

        // 更简洁的时间输入提示方案
        function setupTimeInputEvents() {
            // 为所有现有的时间输入框添加事件监听
            document.addEventListener('focusin', function (e) {
                if (e.target.classList.contains('time-input')) {
                    showTimeHint(e.target);
                }
            });

            document.addEventListener('input', function (e) {
                if (e.target.classList.contains('time-input')) {
                    showTimeHint(e.target);
                }
            });

            document.addEventListener('focusout', function (e) {
                if (e.target.classList.contains('time-input')) {
                    hideTimeHint(e.target);
                }
            });
        }

        function showTimeHint(input) {
            const value = input.value.trim();
            const parent = input.parentNode;

            // 移除可能存在的旧提示
            hideTimeHint(input);

            // 如果是纯数字且不为空，显示提示
            if (/^\d+$/.test(value) && value.length > 0) {
                const hint = document.createElement('div');
                hint.className = 'time-hint';
                hint.textContent = '将自动添加"分钟"单位';
                parent.appendChild(hint);
            }
        }

        function hideTimeHint(input) {
            const parent = input.parentNode;
            const hint = parent.querySelector('.time-hint');
            if (hint) {
                hint.remove();
            }
        }

      
        // 打开召唤同学模态框
        function openCallModal() {
            document.getElementById('callModal').style.display = 'block';
        }

        // 打开重要消息模态框
        function openImportantModal() {
            currentModalType = 'important';
            document.getElementById('importantTitle').value = '';
            initImportantItems();
            document.getElementById('importantModal').style.display = 'block';
        }

        // 初始化重要消息条目
        function initImportantItems() {
            const container = document.getElementById('importantItems');
            container.innerHTML = '';
            addImportantItem(); // 默认添加一个空条目
        }

        // 添加重要消息条目
        function addImportantItem() {
            const container = document.getElementById('importantItems');
            const itemCount = container.children.length + 1;

            const itemRow = document.createElement('div');
            itemRow.className = 'item-row';
            itemRow.innerHTML = `
                            <div class="item-number">${itemCount}.</div>
                            <input type="text" class="item-input" placeholder="消息内容 ${itemCount}">
                            <button class="remove-btn" onclick="removeItem(this)">删除</button>
                        `;
            container.appendChild(itemRow);
        }

        // 删除条目
        function removeItem(button) {
            const itemRow = button.parentElement;
            itemRow.remove();
            // 重新编号
            renumberItems();
        }

        // 重新编号条目
        function renumberItems() {
            const containers = ['homeworkItems', 'readingItems', 'importantItems'];
            containers.forEach(containerId => {
                const container = document.getElementById(containerId);
                if (container) {
                    const items = container.querySelectorAll('.item-row');
                    items.forEach((item, index) => {
                        const numberDiv = item.querySelector('.item-number');
                        if (numberDiv) {
                            numberDiv.textContent = `${index + 1}.`;
                        }
                    });
                }
            });
        }

        // 保存作业模板到本地存储
        function saveHomeworkTemplate() {
            const title = document.getElementById('homeworkTitle').value;
            const items = Array.from(document.querySelectorAll('#homeworkItems .item-input'))
                .map(input => input.value)
                .filter(value => value.trim() !== '');

            const template = { title, items };
            localStorage.setItem('homeworkTemplate', JSON.stringify(template));
            showToast('作业模板已保存', 'success');
        }

        // 加载作业模板
        function loadHomeworkTemplate() {
            const templateStr = localStorage.getItem('homeworkTemplate');
            if (!templateStr) {
                showToast('没有找到保存的模板', 'error');
                return;
            }

            try {
                const template = JSON.parse(templateStr);
                document.getElementById('homeworkTitle').value = template.title || '';

                const container = document.getElementById('homeworkItems');
                container.innerHTML = '';

                template.items.forEach((item, index) => {
                    const itemRow = document.createElement('div');
                    itemRow.className = 'item-row';
                    itemRow.innerHTML = `
                                    <div class="item-number">${index + 1}.</div>
                                    <input type="text" class="item-input" value="${item}">
                                    <button class="remove-btn" onclick="removeItem(this)">删除</button>
                                `;
                    container.appendChild(itemRow);
                });

                showToast('作业模板已加载', 'success');
            } catch (error) {
                showToast('加载模板失败', 'error');
            }
        }

        // 保存早晚读模板
        function saveReadingTemplate() {
            const title = document.getElementById('readingTitle').value;
            const items = Array.from(document.querySelectorAll('#readingItems .item-row')).map(row => {
                const content = row.querySelector('.item-input').value;
                const time = row.querySelector('.time-input').value;
                return { content, time };
            }).filter(item => item.content.trim() !== '');

            const template = { title, items };
            localStorage.setItem('readingTemplate', JSON.stringify(template));
            showToast('早晚读模板已保存', 'success');
        }

        // 加载早晚读模板
        function loadReadingTemplate() {
            const templateStr = localStorage.getItem('readingTemplate');
            if (!templateStr) {
                showToast('没有找到保存的模板', 'error');
                return;
            }

            try {
                const template = JSON.parse(templateStr);
                document.getElementById('readingTitle').value = template.title || '';

                const container = document.getElementById('readingItems');
                container.innerHTML = '';

                template.items.forEach((item, index) => {
                    const itemRow = document.createElement('div');
                    itemRow.className = 'item-row';
                    itemRow.innerHTML = `
                        <div class="item-number">${index + 1}.</div>
                        <input type="text" class="item-input" value="${item.content}">
                        <input type="text" class="time-input" value="${item.time || ''}" placeholder="进行时间（分钟）" onblur="formatTimeInput(this)">
                        <button class="remove-btn" onclick="removeItem(this)">删除</button>
                    `;
                    container.appendChild(itemRow);
                });

                showToast('早晚读模板已加载', 'success');
            } catch (error) {
                showToast('加载模板失败', 'error');
            }
        }

        // 保存重要消息模板
        function saveImportantTemplate() {
            const title = document.getElementById('importantTitle').value;
            const items = Array.from(document.querySelectorAll('#importantItems .item-input'))
                .map(input => input.value)
                .filter(value => value.trim() !== '');

            const template = { title, items };
            localStorage.setItem('importantTemplate', JSON.stringify(template));
            showToast('重要消息模板已保存', 'success');
        }

        // 加载重要消息模板
        function loadImportantTemplate() {
            const templateStr = localStorage.getItem('importantTemplate');
            if (!templateStr) {
                showToast('没有找到保存的模板', 'error');
                return;
            }

            try {
                const template = JSON.parse(templateStr);
                document.getElementById('importantTitle').value = template.title || '';

                const container = document.getElementById('importantItems');
                container.innerHTML = '';

                template.items.forEach((item, index) => {
                    const itemRow = document.createElement('div');
                    itemRow.className = 'item-row';
                    itemRow.innerHTML = `
                                    <div class="item-number">${index + 1}.</div>
                                    <input type="text" class="item-input" value="${item}">
                                    <button class="remove-btn" onclick="removeItem(this)">删除</button>
                                `;
                    container.appendChild(itemRow);
                });

                showToast('重要消息模板已加载', 'success');
            } catch (error) {
                showToast('加载模板失败', 'error');
            }
        }

    

        // 发布重要消息
        async function publishImportant() {
            const title = document.getElementById('importantTitle').value;
            const items = Array.from(document.querySelectorAll('#importantItems .item-input'))
                .map(input => input.value)
                .filter(value => value.trim() !== '');

            if (!title || items.length === 0) {
                showToast('请填写标题和至少一条消息内容', 'error');
                return;
            }

            try {
                const content = items.map((item, index) => `${index + 1}. ${item}`).join('\n');

                const Notice = AV.Object.extend('Notice');
                const notice = new Notice();
                notice.set('title', `【重要】${title}`);
                notice.set('content', content);
                notice.set('author', currentUser.get('username'));
                notice.set('type', 'important');

                await notice.save();
                showToast('重要消息发布成功！', 'success');
                closeModal('importantModal');

            } catch (error) {
                console.error('发布失败:', error);
                showToast('发布失败：' + error.message, 'error');
            }
        }

        // 页面加载时检查登录状态
        document.addEventListener('DOMContentLoaded', checkLoginStatus);

        // 点击模态框外部关闭
        window.onclick = function (event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // GitHub 配置
        const GITHUB_TOKEN = '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';
        const GITHUB_REPO = 'LHblbsl/22classfile'; // 需要替换为实际值
        const GITHUB_BRANCH = 'main';

        // 上传文件到 GitHub
        async function uploadToGitHub(file, type, onProgress) {
            return new Promise(async (resolve, reject) => {
                try {
                    // 生成唯一文件名：时间戳 + 随机数
                    const timestamp = Date.now();
                    const random = Math.random().toString(36).substring(2, 8);
                    const fileExtension = file.name.split('.').pop();
                    const uniqueFileName = `${type}_${timestamp}_${random}.${fileExtension}`;
                    const filePath = `uploads/${type}/${uniqueFileName}`;

                    // 读取文件内容
                    const reader = new FileReader();

                    reader.onload = async function (e) {
                        try {
                            const content = btoa(new Uint8Array(e.target.result).reduce(
                                (data, byte) => data + String.fromCharCode(byte), ''
                            ));

                            // 模拟上传进度
                            let progress = 0;
                            const progressInterval = setInterval(() => {
                                progress += 20;
                                if (onProgress) onProgress(progress);
                                if (progress >= 100) {
                                    clearInterval(progressInterval);
                                }
                            }, 200);

                            // 创建 GitHub API 请求
                            const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${filePath}`, {
                                method: 'PUT',
                                headers: {
                                    'Authorization': `token ${GITHUB_TOKEN}`,
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    message: `Upload ${file.name} as ${uniqueFileName}`,
                                    content: content,
                                    branch: GITHUB_BRANCH
                                })
                            });

                            if (!response.ok) {
                                const errorData = await response.json();
                                throw new Error(errorData.message || '上传失败');
                            }

                            const result = await response.json();
                            resolve({
                                url: result.content.download_url,
                                name: file.name, // 原始文件名
                                uniqueName: uniqueFileName, // 重命名后的文件名
                                size: file.size,
                                githubPath: filePath
                            });

                        } catch (error) {
                            reject(error);
                        }
                    };

                    reader.onerror = () => reject(new Error('文件读取失败'));
                    reader.readAsArrayBuffer(file);

                } catch (error) {
                    reject(error);
                }
            });
        }

        // 图片和文件管理
        let currentImages = {
            homework: [],
            reading: [],
            important: []
        };

        let currentFiles = {
            homework: [],
            reading: []
        };

        // 添加上传统计管理
        let uploadStats = {
            homework: { todayUsage: 0, maxDaily: 100 * 1024 * 1024 }, // 100MB
            reading: { todayUsage: 0, maxDaily: 100 * 1024 * 1024 }   // 100MB
        };
        function updateFileUploadText(type) {
            const uploadArea = document.getElementById(`${type}FileUpload`);
            if (uploadArea) {
                const hint = uploadArea.querySelector('.file-upload-hint');
                if (hint) {
                    hint.textContent = '单个文件不超过100MB，今日总上限100MB';
                }
            }
        }
        // 触发图片上传
        function triggerImageUpload(type) {
            document.getElementById(`${type}ImageInput`).click();
        }

      
        // 移除图片
        function removeImage(type, fileName) {
            currentImages[type] = currentImages[type].filter(img => img.file.name !== fileName);
            updateImagePreview(type);
        }

        // 更新图片预览
        function updateImagePreview(type) {
            const previewArea = document.getElementById(`${type}ImagePreview`);
            previewArea.innerHTML = '';

            if (currentImages[type].length === 0) {
                previewArea.style.display = 'none';
                return;
            }

            currentImages[type].forEach(img => {
                const imageItem = document.createElement('div');
                imageItem.className = 'image-preview-item';
                imageItem.innerHTML = `
            <img src="${img.preview}" class="image-preview" alt="预览">
            <button class="remove-image-btn" onclick="removeImage('${type}', '${img.file.name}')">×</button>
        `;
                previewArea.appendChild(imageItem);
            });
            previewArea.style.display = 'block';
        }

        // 触发文件上传
        function triggerFileUpload(type) {
            document.getElementById(`${type}FileInput`).click();
        }

        // 处理拖拽事件
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
        }

        // 处理文件拖放
        async function handleFileDrop(type, event) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');

            const files = event.dataTransfer.files;
            await handleFileUpload(type, files);
        }

        // 处理文件上传
        // 处理文件上传
        async function handleFileUpload(type, files) {
            const fileList = document.getElementById(`${type}FileList`);
            const stats = uploadStats[type];

            if (!fileList) {
                console.error(`找不到文件列表元素: ${type}FileList`);
                return;
            }

            // 如果没有文件，直接返回
            if (!files || files.length === 0) {
                return;
            }

            // 设置上传状态
            updateUploadStatus(type, { uploading: true, success: false, error: false });

            let uploadCount = 0;
            let totalFiles = Array.from(files).length;
            let hasError = false;

            for (const file of Array.from(files)) {
                if (file.size > 100 * 1024 * 1024) {
                    showToast(`文件 ${file.name} 超过100MB限制`, 'error');
                    uploadCount++;
                    hasError = true;
                    continue;
                }

                if (stats.todayUsage + file.size > stats.maxDaily) {
                    showToast('今日上传额度已用完，请使用QQ发送文件', 'error');
                    uploadCount++;
                    hasError = true;
                    continue;
                }

                const fileId = Date.now() + Math.random();
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
            <div class="file-info">
                <div class="file-icon">📄</div>
                <div class="file-details">
                    <div class="file-name">${file.name}</div>
                    <div class="file-size">${formatFileSize(file.size)}</div>
                    <div class="upload-progress">
                        <div class="progress-bar" id="progress-${fileId}"></div>
                    </div>
                    <div class="progress-text" id="progress-text-${fileId}">准备上传...</div>
                </div>
            </div>
            <button class="file-remove" onclick="removeFile('${type}', '${fileId}')">删除</button>
        `;
                fileList.appendChild(fileItem);

                const progressBar = document.getElementById(`progress-${fileId}`);
                const progressText = document.getElementById(`progress-text-${fileId}`);
                progressBar.parentElement.style.display = 'block';

                try {
                    const result = await uploadToGitHub(file, 'files', (progress) => {
                        progressBar.style.width = `${progress}%`;
                        progressText.textContent = `上传中... ${progress}%`;
                        if (progress === 100) {
                            progressText.textContent = '上传完成，等待确认...';
                        }
                    });

                    // 上传成功，更新进度条为绿色
                    progressBar.style.background = 'linear-gradient(135deg, #00b894, #00a085)';
                    progressText.textContent = '上传成功';
                    progressText.style.color = '#00b894';

                    // 保存文件信息
                    currentFiles[type].push({
                        id: fileId,
                        file: file,
                        uploadTime: new Date(),
                        githubUrl: result.url,
                        name: result.name,
                        uniqueName: result.uniqueName,
                        size: file.size
                    });

                    stats.todayUsage += file.size;
                    updateUploadStats(type);

                    showToast(`文件 ${file.name} 上传成功`, 'success');

                } catch (error) {
                    console.error('文件上传失败:', error);
                    progressText.textContent = '上传失败';
                    progressText.style.color = '#e74c3c';
                    progressBar.style.background = '#e74c3c';
                    showToast(`文件 ${file.name} 上传失败: ${error.message}`, 'error');
                    hasError = true;
                } finally {
                    uploadCount++;
                    // 所有文件处理完成后更新状态
                    if (uploadCount === totalFiles) {
                        updateUploadStatus(type, {
                            uploading: false,
                            error: hasError
                        });
                    }
                }
            }
        }

        // 修改处理图片上传的函数
        async function handleImageUpload(type, files) {
            const maxSize = 10 * 1024 * 1024;
            const previewArea = document.getElementById(`${type}ImagePreview`);

            if (!currentImages[type]) {
                currentImages[type] = [];
            }

            // 如果没有文件，直接返回
            if (!files || files.length === 0) {
                return;
            }

            // 设置上传状态
            updateUploadStatus(type, { uploading: true, success: false, error: false });

            let uploadCount = 0;
            let totalFiles = Array.from(files).length;
            let hasError = false;

            for (const file of Array.from(files)) {
                if (file.size > maxSize) {
                    showToast(`图片 ${file.name} 超过10MB限制`, 'error');
                    uploadCount++;
                    hasError = true;
                    continue;
                }

                const reader = new FileReader();
                reader.onload = async function (e) {
                    const imageItem = document.createElement('div');
                    imageItem.className = 'image-preview-item';
                    imageItem.innerHTML = `
                <img src="${e.target.result}" class="image-preview" alt="预览">
                <div class="upload-progress">
                    <div class="progress-bar" id="image-progress-${file.name}"></div>
                </div>
                <div class="progress-text" id="image-progress-text-${file.name}">准备上传...</div>
                <button class="remove-image-btn" onclick="removeImage('${type}', '${file.name}')">×</button>
            `;
                    previewArea.appendChild(imageItem);
                    previewArea.style.display = 'block';

                    const progressBar = document.getElementById(`image-progress-${file.name}`);
                    const progressText = document.getElementById(`image-progress-text-${file.name}`);
                    progressBar.parentElement.style.display = 'block';

                    try {
                        const result = await uploadToGitHub(file, 'images', (progress) => {
                            progressBar.style.width = `${progress}%`;
                            progressText.textContent = `上传中... ${progress}%`;
                            if (progress === 100) {
                                progressText.textContent = '上传完成，等待确认...';
                            }
                        });

                        // 上传成功，更新进度条为绿色
                        progressBar.style.background = 'linear-gradient(135deg, #00b894, #00a085)';
                        progressText.textContent = '上传成功';
                        progressText.style.color = '#00b894';

                        // 保存图片信息
                        const imageInfo = {
                            file: file,
                            preview: e.target.result,
                            uploadTime: new Date(),
                            id: Date.now() + Math.random(),
                            githubUrl: result.url,
                            name: result.name,
                            uniqueName: result.uniqueName,
                            size: file.size
                        };

                        currentImages[type].push(imageInfo);
                        console.log('图片上传成功:', imageInfo);

                        // 显示成功消息
                        showToast(`图片 ${file.name} 上传成功`, 'success');

                    } catch (error) {
                        console.error('图片上传失败:', error);
                        progressText.textContent = '上传失败';
                        progressText.style.color = '#e74c3c';
                        progressBar.style.background = '#e74c3c';
                        showToast(`图片 ${file.name} 上传失败: ${error.message}`, 'error');
                        hasError = true;
                    } finally {
                        uploadCount++;
                        // 所有文件处理完成后更新状态
                        if (uploadCount === totalFiles) {
                            updateUploadStatus(type, {
                                uploading: false,
                                error: hasError
                            });
                        }
                    }
                };
                reader.readAsDataURL(file);
            }
        }


        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        // 移除文件
        function removeFile(type, fileId) {
            const fileIndex = currentFiles[type].findIndex(f => f.id == fileId);
            if (fileIndex !== -1) {
                const file = currentFiles[type][fileIndex];
                // 恢复额度
                uploadStats[type].todayUsage -= file.file.size;
                updateUploadStats(type);

                // 从数组中移除
                currentFiles[type].splice(fileIndex, 1);

                // 从UI移除
                const fileItems = document.querySelectorAll(`#${type}FileList .file-item`);
                fileItems.forEach(item => {
                    const removeBtn = item.querySelector('.file-remove');
                    if (removeBtn && removeBtn.getAttribute('onclick').includes(fileId)) {
                        item.remove();
                    }
                });
            }
        }

        // 更新上传统计显示
        function updateUploadStats(type) {
            const stats = uploadStats[type];
            const remaining = Math.max(0, stats.maxDaily - stats.todayUsage);

            // 安全地更新DOM元素
            const todayUsageEl = document.getElementById(`${type}TodayUsage`);
            const remainingEl = document.getElementById(`${type}Remaining`);

            if (todayUsageEl) {
                todayUsageEl.textContent = `${(stats.todayUsage / 1024 / 1024).toFixed(2)}MB / 30MB`;
            }

            if (remainingEl) {
                remainingEl.textContent = `${(remaining / 1024 / 1024).toFixed(2)}MB`;
            }
        }

        // 重置文件上传状态（每天重置）
        function resetDailyUploadStats() {
            const today = new Date().toDateString();
            const lastReset = localStorage.getItem('lastUploadReset');

            if (lastReset !== today) {
                uploadStats.homework.todayUsage = 0;
                uploadStats.reading.todayUsage = 0;
                localStorage.setItem('lastUploadReset', today);

                // 更新显示
                updateUploadStats('homework');
                updateUploadStats('reading');
            }
        }

        // 修改显示文件设置的函数
        function showFileSettings(type) {
            const fileInfo = document.getElementById(`${type}FileInfo`);
            if (fileInfo) {
                if (fileInfo.style.display === 'none' || !fileInfo.style.display) {
                    fileInfo.style.display = 'block';
                    resetDailyUploadStats();
                    updateUploadStats(type);
                } else {
                    fileInfo.style.display = 'none';
                }
            }
        }
        // 跳转到学生召唤页面
        function goToStudentSummon() {
            window.location.href = 'student-summon.html';
        }
        // 修改模态框打开函数，初始化文件状态
        // 修改模态框打开函数，重置上传状态
        // 在打开作业模态框时重置时间设置
        function openHomeworkModal() {
            currentModalType = 'homework';
            document.getElementById('homeworkTitle').value = '';
            currentImages.homework = [];
            currentFiles.homework = [];

            // 重置时间设置
            timeSettings.homework = {
                mode: 'countdown',
                applyTo: 'all',
                countdownHours: null,
                deadline: null,
                itemDeadlines: {}
            };

            updateImagePreview('homework');
            document.getElementById('homeworkImagePreview').style.display = 'none';
            document.getElementById('homeworkFileInfo').style.display = 'none';
            document.getElementById('homeworkTimeInfo').style.display = 'none'; // 确保时间设置面板关闭

            const fileList = document.getElementById('homeworkFileList');
            if (fileList) fileList.innerHTML = '';
            initHomeworkItems();
            document.getElementById('homeworkModal').style.display = 'block';

            // 重置上传状态
            updateUploadStatus('homework', { uploading: false, success: false, error: false });
            updateFileUploadText('homework');
        }

        function openReadingModal() {
            currentModalType = 'reading';
            document.getElementById('readingTitle').value = '';
            currentImages.reading = [];
            currentFiles.reading = [];
            updateImagePreview('reading');
            document.getElementById('readingImagePreview').style.display = 'none';
            document.getElementById('readingFileInfo').style.display = 'none';
            const fileList = document.getElementById('readingFileList');
            if (fileList) fileList.innerHTML = '';
            initReadingItems();
            document.getElementById('readingModal').style.display = 'block';

            // 重置上传状态
            updateUploadStatus('reading', { uploading: false, success: false, error: false });
            updateFileUploadText('reading');
        }
        // 修改发布作业函数，包含时间信息
        async function publishHomework() {
            const title = document.getElementById('homeworkTitle').value;
            const items = Array.from(document.querySelectorAll('#homeworkItems .item-input'))
                .map(input => input.value)
                .filter(value => value.trim() !== '');

            if (!title || items.length === 0) {
                showToast('请填写标题和至少一条作业内容', 'error');
                return;
            }

            // 只在有文件上传时才检查上传状态
            if (currentFiles.homework.length > 0 && uploadStatus.homework.uploading) {
                showToast('文件正在上传中，请稍后发布', 'error');
                return;
            }

            try {
                const content = items.map((item, index) => `${index + 1}. ${item}`).join('\n');

                const Notice = AV.Object.extend('Notice');
                const notice = new Notice();
                notice.set('title', `【作业】${title}`);
                notice.set('content', content);
                notice.set('author', currentUser.get('username'));
                notice.set('type', 'homework');

                // 保存时间设置信息
                if (timeSettings.homework && Object.keys(timeSettings.homework.itemDeadlines).length > 0) {
                    const itemDeadlines = [];
                    Object.keys(timeSettings.homework.itemDeadlines).forEach(itemIndex => {
                        const deadline = timeSettings.homework.itemDeadlines[itemIndex];
                        if (deadline) {
                            itemDeadlines.push({
                                itemIndex: parseInt(itemIndex),
                                deadline: deadline.toISOString()
                            });
                        }
                    });

                    if (itemDeadlines.length > 0) {
                        notice.set('itemDeadlines', itemDeadlines);
                        console.log('保存时间设置:', itemDeadlines);
                    }
                }

                // 保存文件信息
                if (currentFiles.homework.length > 0) {
                    notice.set('fileCount', currentFiles.homework.length);
                    notice.set('fileNames', currentFiles.homework.map(f => f.name));
                    notice.set('fileUrls', currentFiles.homework.map(f => f.githubUrl));
                    notice.set('fileUniqueNames', currentFiles.homework.map(f => f.uniqueName));
                }

                // 保存图片信息
                if (currentImages.homework.length > 0) {
                    notice.set('images', currentImages.homework.map(img => img.githubUrl));
                    notice.set('imageCount', currentImages.homework.length);
                    notice.set('imageNames', currentImages.homework.map(img => img.name));
                    notice.set('imageUniqueNames', currentImages.homework.map(img => img.uniqueName));
                }

                // 只在有文件上传时才禁用按钮
                if (currentFiles.homework.length > 0 || currentImages.homework.length > 0) {
                    updateUploadStatus('homework', { uploading: true });
                }

                await notice.save();
                showToast('作业发布成功！', 'success');
                closeModal('homeworkModal');

                // 重置时间设置
                timeSettings.homework = {
                    mode: 'countdown',
                    applyTo: 'all',
                    countdownHours: null,
                    deadline: null,
                    itemDeadlines: {}
                };

            } catch (error) {
                console.error('发布失败:', error);
                showToast('发布失败：' + error.message, 'error');
            } finally {
                // 重新启用发布按钮
                updateUploadStatus('homework', { uploading: false });
            }
        }
      
        // 重置作业表单
        function resetHomeworkForm() {
            document.getElementById('homeworkTitle').value = '';
            currentImages.homework = [];
            currentFiles.homework = [];
            updateImagePreview('homework');
            document.getElementById('homeworkImagePreview').style.display = 'none';
            document.getElementById('homeworkFileInfo').style.display = 'none';
            const fileList = document.getElementById('homeworkFileList');
            if (fileList) fileList.innerHTML = '';
            initHomeworkItems();
        }

      

        // 在页面加载时初始化
        document.addEventListener('DOMContentLoaded', function () {
            checkLoginStatus();
            resetDailyUploadStats();
            setupTimeInputEvents(); // 确保时间输入事件已设置
        });
        // 时间设置相关变量
        let timeSettings = {
            homework: {
                mode: 'countdown',
                applyTo: 'all',
                countdownHours: null,
                deadline: null,
                itemDeadlines: {}
            }
        };

        function selectTimeMode(type, mode) {
            // 更新按钮状态
            const buttons = document.querySelectorAll(`#${type}TimeInfo .time-mode-btn`);
            buttons.forEach(btn => {
                if (btn.dataset.mode === mode) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // 显示对应的设置区域
            const countdownSection = document.getElementById(`${type}CountdownSettings`);
            const datetimeSection = document.getElementById(`${type}DatetimeSettings`);

            if (mode === 'countdown') {
                countdownSection.style.display = 'block';
                datetimeSection.style.display = 'none';
            } else {
                countdownSection.style.display = 'none';
                datetimeSection.style.display = 'block';
            }

            timeSettings[type].mode = mode;
        }

        function initItemSelection(type) {
            const container = document.getElementById(`${type}TimeItems`);
            const itemsContainer = document.getElementById(`${type}Items`);

            if (container && itemsContainer) {
                container.innerHTML = '';
                const items = itemsContainer.querySelectorAll('.item-row');

                items.forEach((item, index) => {
                    const input = item.querySelector('.item-input');
                    if (input) {
                        const checkbox = document.createElement('div');
                        checkbox.className = 'time-item-checkbox';
                        const content = input.value.trim() || `条目 ${index + 1}`;
                        checkbox.innerHTML = `
                    <input type="checkbox" id="timeItem${index}" checked>
                    <div class="item-number">${index + 1}.</div>
                    <div class="item-content-preview" title="${content}">${content}</div>
                `;
                        container.appendChild(checkbox);
                    }
                });

                // 如果没有条目，显示提示
                if (container.children.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">暂无作业条目</div>';
                }
            }
        }
        // 显示时间设置
        function showTimeSettings(type) {
            const timeInfo = document.getElementById(`${type}TimeInfo`);
            if (timeInfo) {
                if (timeInfo.style.display === 'none' || !timeInfo.style.display) {
                    timeInfo.style.display = 'block';
                    initTimeSettings(type);
                } else {
                    timeInfo.style.display = 'none';
                }
            }
        }

        // 初始化时间设置
        function initTimeSettings(type) {
            // 初始化月份选项
            initMonthOptions(type);
            // 初始化日期选项
            initDayOptions(type);
            // 初始化小时选项
            initHourOptions(type);
            // 初始化条目选择
            initItemSelection(type);
        }

        // 初始化月份选项
        function initMonthOptions(type) {
            const monthSelect = document.getElementById(`${type}DeadlineMonth`);
            if (monthSelect) {
                monthSelect.innerHTML = '<option value="">月</option>';
                for (let i = 1; i <= 12; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${i}月`;
                    monthSelect.appendChild(option);
                }
            }
        }

        // 初始化日期选项
        function initDayOptions(type) {
            const daySelect = document.getElementById(`${type}DeadlineDay`);
            if (daySelect) {
                daySelect.innerHTML = '<option value="">日</option>';
                for (let i = 1; i <= 31; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${i}日`;
                    daySelect.appendChild(option);
                }
            }
        }

        // 初始化小时选项
        function initHourOptions(type) {
            const hourSelect = document.getElementById(`${type}DeadlineHour`);
            if (hourSelect) {
                hourSelect.innerHTML = '<option value="">时</option>';
                for (let i = 0; i < 24; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${i.toString().padStart(2, '0')}时`;
                    hourSelect.appendChild(option);
                }
            }
        }

        // 初始化条目选择
        function initItemSelection(type) {
            const container = document.getElementById(`${type}TimeItems`);
            const itemsContainer = document.getElementById(`${type}Items`);

            if (container && itemsContainer) {
                container.innerHTML = '';
                const items = itemsContainer.querySelectorAll('.item-row');

                items.forEach((item, index) => {
                    const input = item.querySelector('.item-input');
                    if (input && input.value.trim()) {
                        const checkbox = document.createElement('div');
                        checkbox.className = 'time-item-checkbox';
                        checkbox.innerHTML = `
                    <input type="checkbox" id="timeItem${index}" checked>
                    <label for="timeItem${index}">${input.value}</label>
                `;
                        container.appendChild(checkbox);
                    }
                });
            }
        }

        // 切换时间模式
        function changeTimeMode(type) {
            const mode = document.getElementById(`${type}TimeMode`).value;
            const countdownSection = document.getElementById(`${type}CountdownSettings`);
            const datetimeSection = document.getElementById(`${type}DatetimeSettings`);

            if (mode === 'countdown') {
                countdownSection.style.display = 'block';
                datetimeSection.style.display = 'none';
            } else {
                countdownSection.style.display = 'none';
                datetimeSection.style.display = 'block';
            }

            timeSettings[type].mode = mode;
        }

        // 切换应用范围
        function changeApplyTo(type) {
            const applyTo = document.getElementById(`${type}TimeApply`).value;
            const selectionSection = document.getElementById(`${type}ItemSelection`);

            if (applyTo === 'selected') {
                selectionSection.style.display = 'block';
                initItemSelection(type);
            } else {
                selectionSection.style.display = 'none';
            }

            timeSettings[type].applyTo = applyTo;
        }
        // 应用时间设置
        function applyTimeSettings(type) {
            const mode = timeSettings[type].mode;

            if (mode === 'countdown') {
                const hours = parseFloat(document.getElementById(`${type}CountdownHours`).value);
                if (!hours || hours <= 0) {
                    showToast('请输入有效的剩余时间', 'error');
                    return;
                }

                const deadline = new Date(Date.now() + hours * 60 * 60 * 1000);

                // 获取选中的条目
                const selectedItems = getSelectedTimeItems(type);
                if (selectedItems.length === 0) {
                    showToast('请至少选择一个作业条目', 'error');
                    return;
                }

                // 为选中的条目设置时间
                selectedItems.forEach(itemIndex => {
                    timeSettings[type].itemDeadlines[itemIndex] = deadline;
                });

                showToast(`已为 ${selectedItems.length} 个条目设置截止时间`, 'success');

            } else {
                const month = document.getElementById(`${type}DeadlineMonth`).value;
                const day = document.getElementById(`${type}DeadlineDay`).value;
                const hour = document.getElementById(`${type}DeadlineHour`).value;

                if (!month || !day || !hour) {
                    showToast('请选择完整的日期和时间', 'error');
                    return;
                }

                const now = new Date();
                const year = now.getFullYear();
                const deadline = new Date(year, month - 1, day, hour);

                // 如果选择的时间已经过去，就设置为明年
                if (deadline <= now) {
                    deadline.setFullYear(year + 1);
                }

                // 获取选中的条目
                const selectedItems = getSelectedTimeItems(type);
                if (selectedItems.length === 0) {
                    showToast('请至少选择一个作业条目', 'error');
                    return;
                }

                selectedItems.forEach(itemIndex => {
                    timeSettings[type].itemDeadlines[itemIndex] = deadline;
                });

                showToast(`已为 ${selectedItems.length} 个条目设置截止时间`, 'success');
            }

            // 关闭时间设置面板
            document.getElementById(`${type}TimeInfo`).style.display = 'none';
        }

        // 获取选中的条目索引
        function getSelectedTimeItems(type) {
            const checkboxes = document.querySelectorAll(`#${type}TimeItems input[type="checkbox"]:checked`);
            return Array.from(checkboxes).map(cb => {
                const id = cb.id.replace('timeItem', '');
                return parseInt(id);
            }).filter(index => !isNaN(index));
        }

        // 修改发布作业函数，包含时间信息

        // 计算剩余时间
        function calculateTimeLeft(deadline) {
            const now = new Date();
            const diff = deadline - now;

            if (diff <= 0) return '已截止';

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            if (days > 0) {
                return `${days}天${hours}时${minutes}分`;
            } else if (hours > 0) {
                return `${hours}时${minutes}分${seconds}秒`;
            } else {
                return `${minutes}分${seconds}秒`;
            }
        }

        // 早晚读时间设置相关变量
        let readingTimeSettings = {
            type: 'morning', // morning, evening 或 custom
            startTime: null,
            autoOpenFiles: [],
            autoOpenImages: []
        };

        // 选择早晚读类型
        function selectReadingType(type) {
            const buttons = document.querySelectorAll('#readingTimeInfo .time-mode-btn');
            buttons.forEach(btn => {
                if (btn.dataset.mode === type) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            readingTimeSettings.type = type;

            // 显示/隐藏自定义时间设置
            const customTimeSection = document.getElementById('readingCustomTime');
            if (type === 'custom') {
                customTimeSection.style.display = 'block';
                initCustomTimeOptions();
            } else {
                customTimeSection.style.display = 'none';

                // 设置对应的开始时间
                if (type === 'morning') {
                    readingTimeSettings.startTime = new Date();
                    readingTimeSettings.startTime.setHours(7, 20, 0, 0);
                } else {
                    readingTimeSettings.startTime = new Date();
                    readingTimeSettings.startTime.setHours(18, 0, 0, 0);
                }
            }
        }

        // 初始化自定义时间选项
        function initCustomTimeOptions() {
            // 初始化小时选项
            const hourSelect = document.getElementById('readingCustomHour');
            if (hourSelect) {
                hourSelect.innerHTML = '<option value="">时</option>';
                for (let i = 0; i < 24; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${i.toString().padStart(2, '0')}时`;
                    hourSelect.appendChild(option);
                }
            }

            // 初始化分钟选项
            const minuteSelect = document.getElementById('readingCustomMinute');
            if (minuteSelect) {
                minuteSelect.innerHTML = '<option value="">分</option>';
                for (let i = 0; i < 60; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${i.toString().padStart(2, '0')}分`;
                    minuteSelect.appendChild(option);
                }
            }

            // 初始化秒钟选项
            const secondSelect = document.getElementById('readingCustomSecond');
            if (secondSelect) {
                secondSelect.innerHTML = '<option value="">秒</option>';
                for (let i = 0; i < 60; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${i.toString().padStart(2, '0')}秒`;
                    secondSelect.appendChild(option);
                }
            }
        }


        // 初始化自动打开文件选择
        function initAutoOpenSelection() {
            const container = document.getElementById('readingAutoOpenFiles');
            if (!container) {
                console.error('找不到 readingAutoOpenFiles 容器');
                return;
            }

            container.innerHTML = '';

            let hasItems = false;

            // 添加文件选择 - 确保 currentFiles.reading 存在
            if (currentFiles.reading && currentFiles.reading.length > 0) {
                console.log('找到文件:', currentFiles.reading);
                const fileSection = document.createElement('div');
                fileSection.innerHTML = '<div style="font-weight: 600; margin: 10px 0 5px 0; color: #333;">📎 文件</div>';
                container.appendChild(fileSection);

                currentFiles.reading.forEach((file, index) => {
                    const checkbox = document.createElement('div');
                    checkbox.className = 'time-item-checkbox';
                    checkbox.innerHTML = `
                <input type="checkbox" id="autoOpenFile${index}" 
                       onchange="toggleAutoOpenFile(${index}, this.checked)">
                <div class="item-content-preview" title="${file.name}">${file.name}</div>
            `;
                    container.appendChild(checkbox);
                    hasItems = true;
                });
            } else {
                console.log('没有找到文件', currentFiles);
            }

            // 添加图片选择 - 确保 currentImages.reading 存在
            if (currentImages.reading && currentImages.reading.length > 0) {
                console.log('找到图片:', currentImages.reading);
                const imageSection = document.createElement('div');
                imageSection.innerHTML = '<div style="font-weight: 600; margin: 10px 0 5px 0; color: #333;">📷 图片</div>';
                container.appendChild(imageSection);

                currentImages.reading.forEach((image, index) => {
                    const checkbox = document.createElement('div');
                    checkbox.className = 'time-item-checkbox';
                    checkbox.innerHTML = `
                <input type="checkbox" id="autoOpenImage${index}" 
                       onchange="toggleAutoOpenImage(${index}, this.checked)">
                <div class="item-content-preview" title="${image.name}">${image.name}</div>
            `;
                    container.appendChild(checkbox);
                    hasItems = true;
                });
            } else {
                console.log('没有找到图片', currentImages);
            }

            // 如果没有文件或图片
            if (!hasItems) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">请先上传文件或图片</div>';
            }
        }


        // 切换自动打开文件
        function toggleAutoOpenFile(index, checked) {
            if (checked) {
                readingTimeSettings.autoOpenFiles.push(currentFiles.reading[index]);
            } else {
                readingTimeSettings.autoOpenFiles = readingTimeSettings.autoOpenFiles.filter(
                    (_, i) => i !== index
                );
            }
        }

        // 切换自动打开图片
        function toggleAutoOpenImage(index, checked) {
            if (checked) {
                readingTimeSettings.autoOpenImages.push(currentImages.reading[index]);
            } else {
                readingTimeSettings.autoOpenImages = readingTimeSettings.autoOpenImages.filter(
                    (_, i) => i !== index
                );
            }
        }

        function applyReadingTimeSettings() {
            // 处理自定义时间
            if (readingTimeSettings.type === 'custom') {
                const hour = document.getElementById('readingCustomHour').value;
                const minute = document.getElementById('readingCustomMinute').value;
                const second = document.getElementById('readingCustomSecond').value;

                if (!hour || !minute || !second) {
                    showToast('请选择完整的时间', 'error');
                    return;
                }

                readingTimeSettings.startTime = new Date();
                readingTimeSettings.startTime.setHours(parseInt(hour), parseInt(minute), parseInt(second), 0);

                // 如果选择的时间已经过去，就设置为明天
                if (readingTimeSettings.startTime <= new Date()) {
                    readingTimeSettings.startTime.setDate(readingTimeSettings.startTime.getDate() + 1);
                }
            }

            if (!readingTimeSettings.startTime) {
                selectReadingType('morning'); // 默认选择早读
            }

            showToast(`已设置${getReadingTypeText(readingTimeSettings.type)}时间`, 'success');

            // 关闭时间设置面板
            document.getElementById('readingTimeInfo').style.display = 'none';
        }
        //获取早晚读类型文本
        function getReadingTypeText(type) {
            switch (type) {
                case 'morning': return '早读';
                case 'evening': return '晚读';
                case 'custom': return '自定义';
                default: return '早晚读';
            }
        }
        // 显示早晚读时间设置
        function showReadingTimeSettings() {
            const timeInfo = document.getElementById('readingTimeInfo');
            if (timeInfo) {
                if (timeInfo.style.display === 'none' || !timeInfo.style.display) {
                    timeInfo.style.display = 'block';
                    // 延迟初始化，确保文件已经加载
                    setTimeout(() => {
                        initAutoOpenSelection();
                    }, 100);
                    // 默认选择早读
                    if (!readingTimeSettings.type) {
                        selectReadingType('morning');
                    }
                } else {
                    timeInfo.style.display = 'none';
                }
            }
        }

        async function publishReading() {
            const title = document.getElementById('readingTitle').value;
            const items = Array.from(document.querySelectorAll('#readingItems .item-row')).map(row => {
                const content = row.querySelector('.item-input').value;
                const time = row.querySelector('.time-input').value;
                return { content, time };
            }).filter(item => item.content.trim() !== '');

            if (!title || items.length === 0) {
                showToast('请填写标题和至少一条阅读内容', 'error');
                return;
            }

            // 只在有文件上传时才检查上传状态
            if (currentFiles.reading.length > 0 && uploadStatus.reading.uploading) {
                showToast('文件正在上传中，请稍后发布', 'error');
                return;
            }

            try {
                let totalMinutes = 0;
                items.forEach(item => {
                    if (item.time) {
                        const minutes = parseInt(item.time) || 0;
                        totalMinutes += minutes;
                    }
                });

                const endTime = readingTimeSettings.startTime ?
                    new Date(readingTimeSettings.startTime.getTime() + totalMinutes * 60 * 1000) : null;

                let content = items.map((item, index) => {
                    if (item.time) {
                        return `${index + 1}. ${item.content}（${item.time}）`;
                    } else {
                        return `${index + 1}. ${item.content}`;
                    }
                }).join('\n');

                const Notice = AV.Object.extend('Notice');
                const notice = new Notice();
                notice.set('title', `【早晚读】${title}`);
                notice.set('content', content);
                notice.set('author', currentUser.get('username'));
                notice.set('type', 'reading');

                // 保存时间设置信息
                if (readingTimeSettings.startTime) {
                    notice.set('readingType', readingTimeSettings.type);
                    notice.set('readingStartTime', readingTimeSettings.startTime.toISOString());
                    notice.set('readingDuration', totalMinutes);
                    if (endTime) {
                        notice.set('readingEndTime', endTime.toISOString());
                    }
                }

                // 保存自动打开文件信息
                if (readingTimeSettings.autoOpenFiles.length > 0) {
                    notice.set('autoOpenFiles', readingTimeSettings.autoOpenFiles.map(f => f.name));
                    notice.set('autoOpenFileUrls', readingTimeSettings.autoOpenFiles.map(f => f.githubUrl));
                    notice.set('autoOpenFileUniqueNames', readingTimeSettings.autoOpenFiles.map(f => f.uniqueName));
                }
                if (readingTimeSettings.autoOpenImages.length > 0) {
                    notice.set('autoOpenImages', readingTimeSettings.autoOpenImages.map(img => img.name));
                    notice.set('autoOpenImageUrls', readingTimeSettings.autoOpenImages.map(img => img.githubUrl));
                    notice.set('autoOpenImageUniqueNames', readingTimeSettings.autoOpenImages.map(img => img.uniqueName));
                }

                // 保存文件信息
                if (currentFiles.reading.length > 0) {
                    notice.set('fileCount', currentFiles.reading.length);
                    notice.set('fileNames', currentFiles.reading.map(f => f.name));
                    notice.set('fileUrls', currentFiles.reading.map(f => f.githubUrl));
                    notice.set('fileUniqueNames', currentFiles.reading.map(f => f.uniqueName));
                }

                // 保存图片信息
                if (currentImages.reading.length > 0) {
                    notice.set('images', currentImages.reading.map(img => img.githubUrl));
                    notice.set('imageCount', currentImages.reading.length);
                    notice.set('imageNames', currentImages.reading.map(img => img.name));
                    notice.set('imageUniqueNames', currentImages.reading.map(img => img.uniqueName));
                }

                // 只在有文件上传时才禁用按钮
                if (currentFiles.reading.length > 0 || currentImages.reading.length > 0) {
                    updateUploadStatus('reading', { uploading: true });
                }

                await notice.save();
                showToast('早晚读发布成功！', 'success');
                closeModal('readingModal');

                // 重置时间设置
                readingTimeSettings = {
                    type: 'morning',
                    startTime: null,
                    autoOpenFiles: [],
                    autoOpenImages: []
                };

            } catch (error) {
                console.error('发布失败:', error);
                showToast('发布失败：' + error.message, 'error');
            } finally {
                // 重新启用发布按钮
                updateUploadStatus('reading', { uploading: false });
            }

        }
        document.addEventListener('DOMContentLoaded', function () {
            checkLoginStatus();
            resetDailyUploadStats();
            setupTimeInputEvents();

            // 初始化上传状态
            updateUploadStatus('homework', { uploading: false, success: false, error: false });
            updateUploadStatus('reading', { uploading: false, success: false, error: false });
        });
        // 替换原来的 uploadStatus 声明
        let uploadStatus = {
            homework: { uploading: false, success: false, error: false },
            reading: { uploading: false, success: false, error: false }
        };
        // 更新上传状态
        function updateUploadStatus(type, status) {
            if (uploadStatus[type]) {
                uploadStatus[type] = { ...uploadStatus[type], ...status };
            }
            updatePublishButtonState(type);
        }

        function updatePublishButtonState(type) {
            const publishButton = document.querySelector(`#${type}Modal .btn:not(.btn-secondary)`);
            if (publishButton) {
                if (uploadStatus[type].uploading) {
                    publishButton.disabled = true;
                    publishButton.style.opacity = '0.6';
                    publishButton.style.cursor = 'not-allowed';
                    publishButton.textContent = type === 'homework' ? '上传中...' : '上传中...';
                } else {
                    publishButton.disabled = false;
                    publishButton.style.opacity = '1';
                    publishButton.style.cursor = 'pointer';
                    publishButton.textContent = type === 'homework' ? '设置作业时间' : '设置早晚读时间';
                }
            }
        }

    </script>
</body>
</html>